<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kur'an-Ä± Kerim Kelime KÃ¶k UzayÄ±</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='%23000' stroke='%2300f2ff' stroke-width='2'/><circle cx='16' cy='16' r='4' fill='%2300f2ff'/></svg>">
    <script>const _w=console.warn;console.warn=(...a)=>{if(typeof a[0]==='string'&&a[0].includes('tailwindcss.com'))return;_w.apply(console,a);};</script>
    <script src="tailwind.min.js"></script>
    <script src="three.min.js"></script>
    <script src="OrbitControls.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Amiri&display=swap');
        
        body { margin: 0; background: #000; color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        canvas { display: block; }

        .hud-panel {
            background: rgba(0, 5, 12, 0.98);
            backdrop-filter: blur(40px);
            border-left: 3px solid #00f2ff;
            box-shadow: -25px 0 100px rgba(0,0,0,1);
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            contain: paint;
        }
        .hud-panel::-webkit-scrollbar { width: 3px; }
        .hud-panel::-webkit-scrollbar-thumb { background: #00f2ff; border-radius: 4px; }

        @media (max-width: 767px) {
            .hud-panel { border-left: none; border-top: 3px solid #00f2ff; }
            .root-badge { min-width: 60px; padding: 8px; }
            .root-pron { font-size: 7px; }
            .ayah-list-item { padding: 10px; }
            .ayah-list-item:hover { transform: none; }
        }

        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: rgba(0, 8, 15, 0.98); border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 20px; margin-top: 10px; max-height: min(480px, 60vh); overflow-y: auto;
            display: none; z-index: 100; backdrop-filter: blur(20px);
        }
        .search-stats-bar {
            padding: 12px 20px; background: rgba(0, 242, 255, 0.15);
            border-bottom: 1px solid rgba(0, 242, 255, 0.3);
            font-size: 10px; font-weight: 900; color: #00f2ff;
            text-transform: uppercase; letter-spacing: 2px;
            display: flex; justify-content: space-between;
            position: sticky; top: 0; z-index: 110;
        }

        .neon-title {
            color: #00f2ff; font-weight: 900; text-transform: uppercase;
            font-style: italic; letter-spacing: -1px;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.6);
        }

        .root-badge {
            padding: 14px 16px; border-radius: 14px; min-width: 90px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; 
            box-shadow: 0 0 15px currentColor;
        }
        .root-pron { font-size: 10px; font-weight: 900; letter-spacing: 1.5px; margin-top: 6px; opacity: 0.8; text-transform: uppercase; color: white; }

        .arabic-text { font-family: 'Amiri', serif; line-height: 1.8; word-spacing: 4px; }
        .root-highlight { 
            text-shadow: 0 0 6px currentColor; 
            font-weight: bold;
            display: inline; transition: color 0.4s;
            border-bottom: 2px solid currentColor;
            padding: 0 1px;
        }

        #tooltip {
            position: fixed; display: none; pointer-events: none;
            background: rgba(0, 5, 12, 0.98); border: 1px solid rgba(0, 242, 255, 0.4);
            padding: 20px; max-width: min(420px, calc(100vw - 40px)); z-index: 1000;
            max-height: min(60vh, calc(100vh - 60px)); overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,1); backdrop-filter: blur(25px);
            border-radius: 1.5rem;
            scrollbar-width: thin; scrollbar-color: #00f2ff transparent;
        }
        #tooltip::-webkit-scrollbar { width: 3px; }
        #tooltip::-webkit-scrollbar-thumb { background: #00f2ff; border-radius: 4px; }

        .ayah-list-item { 
            padding: 14px; border-radius: 15px; background: rgba(255,255,255,0.02); 
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; 
            cursor: pointer; transition: all 0.3s; 
        }
        .ayah-list-item:hover { background: rgba(0, 242, 255, 0.1); border-color: #00f2ff; transform: translateX(10px); }
        
        .mini-root-tag { 
            font-size: 16px; padding: 6px 12px; border-radius: 8px; border: 1px solid; 
            margin-right: 5px; margin-top: 6px; display: inline-flex; 
            flex-direction: column; align-items: center; font-weight: 900; 
            background: rgba(0,0,0,0.4); line-height: 1.2;
            text-shadow: 0 0 6px currentColor;
        }
        .mini-root-pron { 
            font-size: 9px; letter-spacing: 0.8px; opacity: 0.8; 
            margin-top: 3px; color: #fff; text-transform: uppercase; font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #00f2ff; border-radius: 10px; }

        .loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1.2s ease;
            overflow: hidden;
        }
        .loading-screen::before {
            content: ''; position: absolute; inset: 0;
            background:
                radial-gradient(ellipse at 50% 30%, rgba(0,242,255,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 70%, rgba(212,175,55,0.04) 0%, transparent 50%);
            animation: loadBgPulse 6s ease-in-out infinite;
        }
        @keyframes loadBgPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes loadFadeUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes loadGlow {
            0%, 100% { text-shadow: 0 0 20px rgba(212,175,55,0.6), 0 0 60px rgba(212,175,55,0.2), 0 0 100px rgba(0,242,255,0.08); }
            50% { text-shadow: 0 0 40px rgba(212,175,55,0.9), 0 0 80px rgba(212,175,55,0.5), 0 0 140px rgba(0,242,255,0.15), 0 0 200px rgba(212,175,55,0.1); }
        }
        @keyframes loadNeonFlicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { text-shadow: 0 0 10px rgba(0,242,255,0.5), 0 0 30px rgba(0,242,255,0.3), 0 0 60px rgba(0,242,255,0.15); opacity: 1; }
            20%, 24%, 55% { text-shadow: none; opacity: 0.7; }
        }
        @keyframes loadSpin {
            to { transform: rotate(360deg); }
        }
        @keyframes loadPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        @keyframes loadOrnament {
            0%, 100% { opacity: 0.3; letter-spacing: 20px; }
            50% { opacity: 0.7; letter-spacing: 28px; }
        }
        @keyframes loadNeonRing {
            0% { box-shadow: 0 0 5px rgba(0,242,255,0.3), inset 0 0 5px rgba(0,242,255,0.1); }
            50% { box-shadow: 0 0 20px rgba(0,242,255,0.6), 0 0 60px rgba(0,242,255,0.2), inset 0 0 15px rgba(0,242,255,0.15); }
            100% { box-shadow: 0 0 5px rgba(0,242,255,0.3), inset 0 0 5px rgba(0,242,255,0.1); }
        }
        .settings-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(12px);
        }
        .settings-modal {
            background: rgba(0,5,15,0.98); border: 1px solid rgba(0,242,255,0.3);
            border-radius: 2rem; padding: 2.5rem; width: min(520px, calc(100vw - 2rem));
            max-height: calc(100vh - 4rem); overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0,0,0,1);
        }
        .key-item {
            display: flex; align-items: center; gap: 8px; padding: 10px 14px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px; margin-bottom: 8px; font-family: monospace; font-size: 12px;
        }
        .key-item.active { border-color: rgba(0,242,255,0.4); background: rgba(0,242,255,0.05); }
        .key-item .key-text { flex: 1; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .key-item .key-status { font-size: 10px; font-weight: 900; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0; }
        .key-item .key-status.ok { color: #22c55e; background: rgba(34,197,94,0.1); }
        .key-item .key-status.fail { color: #ef4444; background: rgba(239,68,68,0.1); }
        .key-item .key-status.pending { color: #f59e0b; background: rgba(245,158,11,0.1); }
        .key-btn { background: none; border: 1px solid rgba(255,255,255,0.15); color: #94a3b8; width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; flex-shrink: 0; }
        .key-btn:hover { border-color: #ef4444; color: #ef4444; }

        /* Dataset Manager & JSON Editor */
        .ds-modal { position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
        .ds-panel { background: #0a0e14; border: 1px solid rgba(0,242,255,0.2); border-radius: 1.5rem; padding: 2rem; width: min(560px, 92vw); max-height: 80vh; overflow-y: auto; }
        .ds-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); margin-bottom: 6px; transition: all 0.2s; cursor: pointer; }
        .ds-item:hover { background: rgba(0,242,255,0.06); border-color: rgba(0,242,255,0.2); }
        .ds-item.active { background: rgba(0,242,255,0.08); border-color: #00f2ff; }
        .editor-overlay { position: fixed; inset: 0; z-index: 10000; display: none; flex-direction: column; background: #0a0e14; }
        .editor-toolbar { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: #0d1117; border-bottom: 1px solid rgba(0,242,255,0.15); flex-wrap: wrap; }
        .editor-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12); color: #e2e8f0; padding: 7px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.08em; }
        .editor-btn:hover { background: rgba(0,242,255,0.12); border-color: #00f2ff; color: #00f2ff; }
        .editor-btn.save { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: #22c55e; }
        .editor-btn.save:hover { background: rgba(34,197,94,0.3); }
        .editor-btn.danger { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: #ef4444; }
        .editor-main { display: flex; flex: 1; overflow: hidden; position: relative; }
        .editor-lines { width: 54px; background: #0d1117; border-right: 1px solid rgba(255,255,255,0.06); padding: 12px 0; overflow: hidden; user-select: none; text-align: right; font-family: 'Consolas','Monaco',monospace; font-size: 13px; line-height: 1.6; color: #3b4252; flex-shrink: 0; }
        .editor-textarea { flex: 1; background: transparent; color: #e2e8f0; border: none; outline: none; resize: none; padding: 12px 16px; font-family: 'Consolas','Monaco',monospace; font-size: 13px; line-height: 1.6; tab-size: 2; white-space: pre; overflow: auto; }
        .editor-status { display: flex; align-items: center; justify-content: space-between; padding: 6px 16px; background: #0d1117; border-top: 1px solid rgba(255,255,255,0.06); font-size: 11px; }
        .editor-status.valid { color: #22c55e; }
        .editor-status.invalid { color: #ef4444; }
        .arabic-kb { display: none; background: #0d1117; border-top: 1px solid rgba(255,255,255,0.1); padding: 10px; flex-shrink: 0; }
        .arabic-kb.show { display: block; }
        .kb-row { display: flex; gap: 4px; justify-content: center; margin-bottom: 4px; }
        .kb-key { min-width: 36px; height: 36px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #e2e8f0; font-size: 16px; font-family: 'Amiri',serif; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .kb-key:hover { background: rgba(0,242,255,0.15); border-color: #00f2ff; color: #00f2ff; }
        .kb-key.haraka { font-size: 20px; color: #f59e0b; min-width: 32px; }
        .kb-key.special { font-size: 11px; min-width: 56px; font-family: 'Inter',sans-serif; color: #94a3b8; }
        .layout-option { display:block; width:100%; text-align:left; padding:10px 16px; border:none; background:transparent; color:#94a3b8; font-size:12px; font-weight:700; cursor:pointer; border-radius:12px; transition:all 0.2s; font-family:Inter,sans-serif; letter-spacing:0.05em; }
        .layout-option:hover { background:rgba(0,242,255,0.1); color:#00f2ff; }
        .layout-option.active { background:rgba(0,242,255,0.15); color:#00f2ff; border:1px solid rgba(0,242,255,0.3); }
        .layout-option .layout-desc { display:block; font-size:9px; font-weight:400; color:#475569; margin-top:2px; letter-spacing:0.02em; }
        .layout-option.active .layout-desc { color:#0e7490; }

        /* Modern Header */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background: rgba(0,3,8,0.75);
            backdrop-filter: blur(24px) saturate(1.4);
            -webkit-backdrop-filter: blur(24px) saturate(1.4);
            border-bottom: 1px solid rgba(0,242,255,0.08);
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        .app-header:hover { background: rgba(0,3,8,0.88); border-bottom-color: rgba(0,242,255,0.15); }
        .header-inner { display: flex; align-items: center; justify-content: space-between; max-width: 100%; gap: 16px; }
        .header-brand { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .header-logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, rgba(0,242,255,0.15), rgba(0,242,255,0.05)); border: 1px solid rgba(0,242,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .header-title { font-size: 15px; font-weight: 900; color: #00f2ff; letter-spacing: -0.5px; line-height: 1.2; }
        .header-sub { font-size: 8px; color: rgba(0,242,255,0.35); font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
        .header-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .hdr-btn {
            display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 10px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: #94a3b8; font-size: 15px; cursor: pointer;
            transition: all 0.2s ease; position: relative;
        }
        .hdr-btn:hover { background: rgba(0,242,255,0.1); border-color: rgba(0,242,255,0.3); color: #00f2ff; transform: translateY(-1px); }
        .hdr-btn.active { background: rgba(0,242,255,0.12); border-color: rgba(0,242,255,0.25); color: #00f2ff; }
        .hdr-btn-label { display: none; }
        @media (min-width: 768px) {
            .hdr-btn-label { display: inline; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; margin-left: 6px; }
            .hdr-btn.with-label { width: auto; padding: 0 14px; gap: 4px; }
        }
        .hdr-search {
            width: 100%;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 8px 16px;
            color: #fff; font-size: 12px; font-weight: 600;
            outline: none; transition: all 0.2s;
        }
        .hdr-search:focus { border-color: rgba(0,242,255,0.4); background: rgba(0,242,255,0.06); box-shadow: 0 0 20px rgba(0,242,255,0.08); }
        .hdr-search::placeholder { color: rgba(255,255,255,0.2); font-weight: 500; }
        .hdr-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.06); margin: 0 4px; flex-shrink: 0; }

        /* WYSIWYG Notes Editor */
        .notes-overlay {
            position: fixed; inset: 0; z-index: 9000; display: none;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            align-items: center; justify-content: center;
        }
        .notes-overlay.show { display: flex; }
        .notes-panel {
            width: 90vw; max-width: 720px; height: 80vh; max-height: 700px;
            background: rgba(8,12,20,0.98); border: 1px solid rgba(0,242,255,0.12);
            border-radius: 20px; display: flex; flex-direction: column;
            box-shadow: 0 40px 120px rgba(0,0,0,0.9);
            overflow: hidden;
        }
        .notes-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.06);
            background: rgba(0,242,255,0.03);
        }
        .notes-header h3 { font-size: 14px; font-weight: 800; color: #00f2ff; letter-spacing: 0.5px; }
        .notes-body { display: flex; flex: 1; overflow: hidden; }
        .notes-sidebar {
            width: 200px; border-right: 1px solid rgba(255,255,255,0.06);
            overflow-y: auto; padding: 8px; flex-shrink: 0;
            background: rgba(0,0,0,0.3);
        }
        @media (max-width: 640px) { .notes-sidebar { width: 60px; } .notes-sidebar .note-title-text { display: none; } }
        .note-item {
            padding: 10px 12px; border-radius: 10px; cursor: pointer;
            margin-bottom: 4px; transition: all 0.15s;
            border: 1px solid transparent;
        }
        .note-item:hover { background: rgba(0,242,255,0.06); }
        .note-item.active { background: rgba(0,242,255,0.1); border-color: rgba(0,242,255,0.2); }
        .note-item .note-title-text { font-size: 11px; font-weight: 700; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-item .note-date { font-size: 8px; color: #475569; margin-top: 2px; }
        .notes-editor-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .notes-toolbar {
            display: flex; align-items: center; gap: 2px; padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06); flex-wrap: wrap;
        }
        .notes-toolbar button {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            background: transparent; color: #94a3b8; font-size: 13px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.15s; font-weight: 700;
        }
        .notes-toolbar button:hover { background: rgba(0,242,255,0.1); color: #00f2ff; }
        .notes-toolbar .tb-sep { width: 1px; height: 20px; background: rgba(255,255,255,0.06); margin: 0 4px; }
        .notes-title-input {
            width: 100%; padding: 10px 16px; background: transparent;
            border: none; border-bottom: 1px solid rgba(255,255,255,0.06);
            color: #fff; font-size: 16px; font-weight: 800; outline: none;
        }
        .notes-title-input::placeholder { color: rgba(255,255,255,0.15); }
        .notes-content {
            flex: 1; padding: 16px; overflow-y: auto;
            color: #e2e8f0; font-size: 14px; line-height: 1.7;
            outline: none; min-height: 100px;
        }
        .notes-content:empty::before {
            content: 'Notunuzu buraya yazÄ±n...';
            color: rgba(255,255,255,0.15); font-style: italic;
        }
        .notes-content h1 { font-size: 22px; font-weight: 900; color: #00f2ff; margin: 16px 0 8px; }
        .notes-content h2 { font-size: 18px; font-weight: 800; color: #38bdf8; margin: 14px 0 6px; }
        .notes-content h3 { font-size: 15px; font-weight: 700; color: #7dd3fc; margin: 12px 0 4px; }
        .notes-content ul, .notes-content ol { padding-left: 24px; margin: 8px 0; }
        .notes-content li { margin-bottom: 4px; }
        .notes-content blockquote { border-left: 3px solid #00f2ff; padding: 8px 16px; margin: 12px 0; background: rgba(0,242,255,0.04); border-radius: 0 8px 8px 0; color: #94a3b8; font-style: italic; }
        .notes-content a { color: #00f2ff; text-decoration: underline; }
        .notes-content code { background: rgba(0,242,255,0.08); padding: 2px 6px; border-radius: 4px; font-family: Consolas, monospace; font-size: 13px; color: #7dd3fc; }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-screen">
        <!-- Besmele Ses -->
        <audio id="besmele-audio" src="besmele.wav" preload="auto"></audio>

        <!-- Neon arka plan katmanlarÄ± -->
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 50% 35%, rgba(0,242,255,0.06) 0%, rgba(0,242,255,0.02) 25%, transparent 60%);"></div>
        <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 50% 65%, rgba(212,175,55,0.05) 0%, transparent 50%);"></div>
        <div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 20%, rgba(168,85,247,0.03) 0%, transparent 40%);"></div>
        <div style="position:absolute;inset:0;background:radial-gradient(circle at 70% 80%, rgba(168,85,247,0.03) 0%, transparent 40%);"></div>

        <!-- Neon halka -->
        <div style="position:absolute;width:min(500px,80vw);height:min(500px,80vw);border-radius:50%;border:1px solid rgba(0,242,255,0.06);animation:loadNeonRing 4s ease-in-out infinite, loadFadeUp 2s ease 0.2s both;pointer-events:none;"></div>

        <!-- Ãœst sÃ¼sleme -->
        <div style="font-size:14px;color:rgba(0,242,255,0.35);margin-bottom:36px;animation:loadOrnament 5s ease-in-out infinite, loadFadeUp 1.2s ease 0.2s both;">âœ¦ âœ§ âœ¦ âœ§ âœ¦</div>

        <!-- EÃ»zÃ¼ -->
        <p dir="rtl" style="font-family:'Amiri',serif;font-size:clamp(20px,4.5vw,36px);color:rgba(212,175,55,0.6);line-height:1.8;text-align:center;padding:0 24px;text-shadow:0 0 15px rgba(212,175,55,0.3), 0 0 40px rgba(212,175,55,0.1);animation:loadFadeUp 1.2s ease 0.4s both;">
            Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ§Ù„Ù„Ù‡Ù Ù…ÙÙ†Ù Ø§Ù„Ø´ÙÙ‘ÙŠÙ’Ø·ÙØ§Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø¬ÙÙŠÙ…Ù
        </p>

        <!-- Besmele -->
        <p dir="rtl" style="font-family:'Amiri',serif;font-size:clamp(30px,7vw,56px);color:#d4af37;line-height:1.8;text-align:center;padding:0 24px;animation:loadFadeUp 1.2s ease 0.7s both, loadGlow 4s ease-in-out 1.9s infinite;">
            Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ€Ù°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù
        </p>

        <!-- Neon dekoratif ayÄ±rÄ±cÄ± -->
        <div style="display:flex;align-items:center;gap:16px;margin:24px 0;animation:loadFadeUp 1.2s ease 1.0s both;">
            <div style="width:80px;height:1px;background:linear-gradient(to right,transparent,rgba(0,242,255,0.4));"></div>
            <span style="color:rgba(0,242,255,0.5);font-size:16px;text-shadow:0 0 8px rgba(0,242,255,0.4);">â¨â‹â©</span>
            <div style="width:80px;height:1px;background:linear-gradient(to left,transparent,rgba(0,242,255,0.4));"></div>
        </div>

        <!-- TÃ¼rkÃ§e meal -->
        <p style="font-size:clamp(14px,3vw,22px);color:rgba(255,255,255,0.85);font-weight:400;font-style:italic;letter-spacing:0.08em;margin-bottom:6px;text-align:center;padding:0 24px;text-shadow:0 0 12px rgba(0,242,255,0.4), 0 0 30px rgba(0,242,255,0.15);animation:loadFadeUp 1.2s ease 1.3s both;">
            KovulmuÅŸ ÅŸeytandan Allah'a sÄ±ÄŸÄ±nÄ±rÄ±m
        </p>
        <p style="font-size:clamp(16px,3.5vw,26px);color:rgba(255,255,255,0.9);font-weight:500;font-style:italic;letter-spacing:0.08em;margin-bottom:16px;text-align:center;padding:0 24px;text-shadow:0 0 15px rgba(0,242,255,0.5), 0 0 40px rgba(0,242,255,0.2);animation:loadFadeUp 1.2s ease 1.5s both;">
            Rahman ve Rahim olan Allah'Ä±n adÄ±yla
        </p>

        <!-- Latin transliterasyon -->
        <p style="font-size:clamp(10px,2vw,15px);color:rgba(0,242,255,0.6);font-family:'Inter',monospace;letter-spacing:0.3em;text-transform:uppercase;margin-bottom:56px;text-align:center;text-shadow:0 0 8px rgba(0,242,255,0.3), 0 0 20px rgba(0,242,255,0.1);animation:loadFadeUp 1.2s ease 1.7s both, loadNeonFlicker 8s ease-in-out 3s infinite;">
            EÃ»zÃ¼ billÃ¢hi mineÅŸ-ÅŸeytÃ¢nir-racÃ®m Â· BismillÃ¢hirrahmÃ¢nirrahÃ®m
        </p>

        <!-- Spinner -->
        <div id="loading-spinner" style="width:36px;height:36px;border:2px solid rgba(0,242,255,0.1);border-top-color:rgba(0,242,255,0.7);border-radius:50%;box-shadow:0 0 12px rgba(0,242,255,0.2);animation:loadSpin 1.2s linear infinite, loadFadeUp 1s ease 2.0s both;margin-bottom:18px;"></div>

        <!-- Dokunarak baÅŸlat (web modu) -->
        <p id="loading-tap-hint" style="display:none;font-size:11px;color:rgba(0,242,255,0.6);font-family:'Inter',sans-serif;letter-spacing:0.3em;text-transform:uppercase;animation:loadPulse 2s ease-in-out infinite, loadFadeUp 1s ease 2.0s both;cursor:pointer;">â–¶ Dokunarak BaÅŸlat</p>

        <!-- YÃ¼kleniyor -->
        <p id="loading-text" style="font-size:9px;color:rgba(0,242,255,0.35);font-family:'Inter',monospace;letter-spacing:0.6em;text-transform:uppercase;animation:loadPulse 2.5s ease-in-out infinite, loadFadeUp 1s ease 2.0s both;">YÃ¼kleniyor</p>
    </div>

    <canvas id="warp-canvas" style="position:fixed;inset:0;pointer-events:none;z-index:998;display:none;"></canvas>
    <div id="tooltip"></div>

    <!-- GiriÅŸ EkranÄ± -->
    <div id="login-overlay" style="display:none;position:fixed;inset:0;background:#000;z-index:10000;align-items:center;justify-content:center;">
        <div style="max-width:380px;width:90%;padding:40px;background:rgba(0,5,12,0.98);border:1px solid rgba(0,242,255,0.2);border-radius:24px;box-shadow:0 0 80px rgba(0,242,255,0.1);">
            <div style="text-align:center;margin-bottom:24px;">
                <div style="font-size:32px;margin-bottom:12px;">ğŸ”</div>
                <h2 style="color:#00f2ff;font-size:16px;font-weight:900;letter-spacing:6px;text-transform:uppercase;">GiriÅŸ Yap</h2>
            </div>
            <div id="login-error" style="display:none;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:10px;color:#ef4444;font-size:12px;text-align:center;margin-bottom:16px;"></div>
            <input type="text" id="login-username" placeholder="KullanÄ±cÄ± adÄ±" style="width:100%;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px 16px;outline:none;color:white;font-size:13px;margin-bottom:12px;box-sizing:border-box;font-family:Inter,sans-serif;" onkeydown="if(event.key==='Enter')document.getElementById('login-password').focus()">
            <input type="password" id="login-password" placeholder="Åifre" style="width:100%;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px 16px;outline:none;color:white;font-size:13px;margin-bottom:20px;box-sizing:border-box;font-family:Inter,sans-serif;" onkeydown="if(event.key==='Enter')doLogin()">
            <button onclick="doLogin()" style="width:100%;background:linear-gradient(135deg,#0e7490,#06b6d4);border:none;border-radius:12px;padding:12px;color:white;font-size:12px;font-weight:900;letter-spacing:3px;text-transform:uppercase;cursor:pointer;font-family:Inter,sans-serif;">GiriÅŸ</button>
            <p style="text-align:center;color:rgba(148,163,184,0.4);font-size:10px;margin-top:16px;">Ä°lk kurulum: admin / admin123</p>
        </div>
    </div>

    <!-- Ayarlar ModalÄ± -->
    <div id="settings-overlay" class="settings-overlay" style="display:none" onclick="if(event.target===this)closeSettings()">
        <div class="settings-modal">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-cyan-400 uppercase tracking-widest">âš™ï¸ Ayarlar</h2>
                <button onclick="closeSettings()" class="w-9 h-9 flex items-center justify-center bg-white/5 rounded-full text-slate-500 hover:text-white transition-all">âœ•</button>
            </div>
            <div class="mb-6" id="auth-info-section">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-3">ğŸ‘¤ KullanÄ±cÄ± Bilgileri</h3>
                <div id="auth-user-info"></div>
                <div id="server-status" class="mt-3 text-[10px] text-slate-600"></div>
            </div>
            <div class="mb-6" id="change-pw-section" style="display:none">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-3">ğŸ”‘ Åifre DeÄŸiÅŸtir</h3>
                <div class="flex flex-col gap-2">
                    <input type="password" id="old-pw-input" placeholder="Mevcut ÅŸifre" class="bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-cyan-400 text-xs text-white placeholder-slate-700">
                    <input type="password" id="new-pw-input" placeholder="Yeni ÅŸifre" class="bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-cyan-400 text-xs text-white placeholder-slate-700">
                    <button onclick="changePassword()" class="bg-cyan-950 hover:bg-cyan-800 border border-cyan-400/30 px-5 py-2.5 rounded-xl font-black text-[10px] text-white uppercase tracking-widest transition-all">Åifreyi GÃ¼ncelle</button>
                </div>
                <div id="pw-change-msg" class="mt-2 text-[10px]"></div>
            </div>
            <div class="mb-6">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-3">Gemini API AnahtarlarÄ±</h3>
                <p class="text-[11px] text-slate-600 mb-4">Birden fazla anahtar ekleyebilirsiniz. Ã‡alÄ±ÅŸan ilk anahtar otomatik kullanÄ±lÄ±r.</p>
                <div id="api-key-list"></div>
                <div class="flex gap-2 mt-3">
                    <input type="password" id="new-key-input" placeholder="AIza..." class="flex-1 bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-cyan-400 text-xs text-white font-mono placeholder-slate-700">
                    <button onclick="addApiKey()" class="bg-cyan-950 hover:bg-cyan-800 border border-cyan-400/30 px-5 py-2.5 rounded-xl font-black text-[10px] text-white uppercase tracking-widest transition-all">Ekle</button>
                </div>
                <button onclick="testAllKeys()" class="w-full mt-3 bg-purple-950/50 hover:bg-purple-900/50 border border-purple-400/20 px-4 py-2.5 rounded-xl font-black text-[10px] text-purple-300 uppercase tracking-widest transition-all">ğŸ” TÃ¼m AnahtarlarÄ± Test Et</button>
            </div>
            <div id="api-key-guide" class="hidden mb-4 bg-amber-950/30 border border-amber-400/20 rounded-2xl p-5">
                <h4 class="text-amber-400 font-black text-xs uppercase tracking-widest mb-3">ğŸ”‘ API AnahtarÄ± NasÄ±l AlÄ±nÄ±r?</h4>
                <ol class="text-[12px] text-slate-300 leading-relaxed space-y-2">
                    <li><span class="text-cyan-400 font-bold">1.</span> <a href="https://aistudio.google.com/apikey" target="_blank" class="text-cyan-400 underline hover:text-cyan-300">Google AI Studio</a> sayfasÄ±na gidin</li>
                    <li><span class="text-cyan-400 font-bold">2.</span> Google hesabÄ±nÄ±zla giriÅŸ yapÄ±n</li>
                    <li><span class="text-cyan-400 font-bold">3.</span> <strong class="text-white">"Create API Key"</strong> butonuna tÄ±klayÄ±n</li>
                    <li><span class="text-cyan-400 font-bold">4.</span> OluÅŸan <code class="bg-black/40 px-2 py-0.5 rounded text-cyan-300">AIza...</code> anahtarÄ±nÄ± kopyalayÄ±n</li>
                    <li><span class="text-cyan-400 font-bold">5.</span> YukarÄ±daki kutuya yapÄ±ÅŸtÄ±rÄ±p <strong class="text-white">Ekle</strong>'ye basÄ±n</li>
                </ol>
                <p class="text-[10px] text-amber-600 mt-3">ğŸ’¡ Ãœcretsiz plan gÃ¼nlÃ¼k kullanÄ±m iÃ§in yeterlidir. Birden fazla anahtar ekleyebilirsiniz.</p>
            </div>
            <div class="border-t border-white/5 pt-4">
                <p class="text-[10px] text-slate-700 leading-relaxed">ğŸ”’ AnahtarlarÄ±nÄ±z tarayÄ±cÄ±nÄ±zda ÅŸifrelenmiÅŸ olarak saklanÄ±r. Sunucuya gÃ¶nderilmez.</p>
            </div>
        </div>
    </div>

    <!-- KullanÄ±cÄ± YÃ¶netimi -->
    <div id="admin-overlay" class="settings-overlay" style="display:none" onclick="if(event.target===this)closeAdmin()">
        <div class="settings-modal" style="max-width:500px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-cyan-400 uppercase tracking-widest">ğŸ‘¥ KullanÄ±cÄ±lar</h2>
                <button onclick="closeAdmin()" class="w-9 h-9 flex items-center justify-center bg-white/5 rounded-full text-slate-500 hover:text-white transition-all">âœ•</button>
            </div>
            <div id="admin-user-list" class="mb-6"></div>
            <div class="border-t border-white/5 pt-4">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-3">Yeni KullanÄ±cÄ±</h3>
                <div class="flex flex-col gap-2">
                    <input type="text" id="new-user-name" placeholder="KullanÄ±cÄ± adÄ±" class="bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-cyan-400 text-xs text-white placeholder-slate-700">
                    <input type="password" id="new-user-pass" placeholder="Åifre" class="bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none focus:border-cyan-400 text-xs text-white placeholder-slate-700">
                    <div class="flex gap-2">
                        <select id="new-user-role" class="flex-1 bg-black/60 border border-white/10 rounded-xl px-4 py-2.5 outline-none text-xs text-white">
                            <option value="viewer">ğŸ‘ Viewer</option>
                            <option value="editor">âœï¸ Editor</option>
                            <option value="admin">ğŸ‘‘ Admin</option>
                        </select>
                        <button onclick="createUser()" class="bg-cyan-950 hover:bg-cyan-800 border border-cyan-400/30 px-5 py-2.5 rounded-xl font-black text-[10px] text-white uppercase tracking-widest transition-all">Ekle</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Veri Seti YÃ¶neticisi -->
    <div id="dataset-overlay" class="ds-modal" onclick="if(event.target===this)closeDatasets()">
        <div class="ds-panel">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-black text-cyan-400 uppercase tracking-widest">ğŸ“‚ Veri Setleri</h2>
                <button onclick="closeDatasets()" class="w-9 h-9 flex items-center justify-center bg-white/5 rounded-full text-slate-500 hover:text-white transition-all">âœ•</button>
            </div>
            <div id="dataset-list"></div>
        </div>
    </div>

    <!-- JSON EditÃ¶r -->
    <div id="json-editor" class="editor-overlay">
        <div class="editor-toolbar">
            <span class="text-cyan-400 font-black text-xs uppercase tracking-widest mr-auto" id="editor-title">ğŸ“ JSON EditÃ¶r</span>
            <button class="editor-btn save" onclick="editorSave()">ğŸ’¾ Kaydet</button>
            <button class="editor-btn" onclick="editorExport()" style="color:#38bdf8;">â¬‡ DÄ±ÅŸa Aktar</button>
            <button class="editor-btn" onclick="editorFormat()">{ } Format</button>
            <button class="editor-btn" onclick="editorValidate()">âœ“ DoÄŸrula</button>
            <button class="editor-btn" onclick="editorAddDipnot()">ğŸ“Œ Dipnot Ekle</button>
            <button class="editor-btn" id="kb-toggle" onclick="toggleArabicKb()">âŒ¨ ArapÃ§a</button>
            <button class="editor-btn danger" onclick="closeEditor()">âœ• Kapat</button>
        </div>
        <div class="editor-main">
            <div class="editor-lines" id="editor-lines"></div>
            <textarea class="editor-textarea" id="editor-textarea" spellcheck="false"></textarea>
        </div>
        <div class="arabic-kb" id="arabic-kb">
            <div class="kb-row">
                <button class="kb-key" onclick="kbInsert('Ø¶')">Ø¶</button><button class="kb-key" onclick="kbInsert('Øµ')">Øµ</button>
                <button class="kb-key" onclick="kbInsert('Ø«')">Ø«</button><button class="kb-key" onclick="kbInsert('Ù‚')">Ù‚</button>
                <button class="kb-key" onclick="kbInsert('Ù')">Ù</button><button class="kb-key" onclick="kbInsert('Øº')">Øº</button>
                <button class="kb-key" onclick="kbInsert('Ø¹')">Ø¹</button><button class="kb-key" onclick="kbInsert('Ù‡')">Ù‡</button>
                <button class="kb-key" onclick="kbInsert('Ø®')">Ø®</button><button class="kb-key" onclick="kbInsert('Ø­')">Ø­</button>
                <button class="kb-key" onclick="kbInsert('Ø¬')">Ø¬</button><button class="kb-key" onclick="kbInsert('Ø¯')">Ø¯</button>
            </div>
            <div class="kb-row">
                <button class="kb-key" onclick="kbInsert('Ø´')">Ø´</button><button class="kb-key" onclick="kbInsert('Ø³')">Ø³</button>
                <button class="kb-key" onclick="kbInsert('ÙŠ')">ÙŠ</button><button class="kb-key" onclick="kbInsert('Ø¨')">Ø¨</button>
                <button class="kb-key" onclick="kbInsert('Ù„')">Ù„</button><button class="kb-key" onclick="kbInsert('Ø§')">Ø§</button>
                <button class="kb-key" onclick="kbInsert('Øª')">Øª</button><button class="kb-key" onclick="kbInsert('Ù†')">Ù†</button>
                <button class="kb-key" onclick="kbInsert('Ù…')">Ù…</button><button class="kb-key" onclick="kbInsert('Ùƒ')">Ùƒ</button>
                <button class="kb-key" onclick="kbInsert('Ø·')">Ø·</button>
            </div>
            <div class="kb-row">
                <button class="kb-key" onclick="kbInsert('Ø¦')">Ø¦</button><button class="kb-key" onclick="kbInsert('Ø¡')">Ø¡</button>
                <button class="kb-key" onclick="kbInsert('Ø¤')">Ø¤</button><button class="kb-key" onclick="kbInsert('Ø±')">Ø±</button>
                <button class="kb-key" onclick="kbInsert('Ù‰')">Ù‰</button><button class="kb-key" onclick="kbInsert('Ø©')">Ø©</button>
                <button class="kb-key" onclick="kbInsert('Ùˆ')">Ùˆ</button><button class="kb-key" onclick="kbInsert('Ø²')">Ø²</button>
                <button class="kb-key" onclick="kbInsert('Ø¸')">Ø¸</button><button class="kb-key" onclick="kbInsert('Ø°')">Ø°</button>
                <button class="kb-key" onclick="kbInsert('Ø£')">Ø£</button><button class="kb-key" onclick="kbInsert('Ø¥')">Ø¥</button>
                <button class="kb-key" onclick="kbInsert('Ø¢')">Ø¢</button>
            </div>
            <div class="kb-row">
                <button class="kb-key haraka" onclick="kbInsert('\u064E')">&#x64E;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u064B')">&#x64B;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u064F')">&#x64F;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u064C')">&#x64C;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u0650')">&#x650;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u064D')">&#x64D;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u0651')">&#x651;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u0652')">&#x652;</button>
                <button class="kb-key haraka" onclick="kbInsert('\u0670')">&#x670;</button>
                <button class="kb-key special" onclick="kbInsert(' ')">BoÅŸluk</button>
                <button class="kb-key special" onclick="kbBackspace()">âŒ« Sil</button>
            </div>
        </div>
        <div class="editor-status valid" id="editor-status">
            <span id="editor-msg">âœ“ GeÃ§erli JSON</span>
            <span id="editor-info"></span>
        </div>
    </div>

    <!-- Modern Header -->
    <div class="app-header" id="app-header">
        <div class="header-inner">
            <div class="header-brand">
                <div class="header-logo">ğŸ•‹</div>
                <div>
                    <div class="header-title">Kur'an-Ä± Kerim Kelime KÃ¶k UzayÄ±</div>
                    <div class="header-sub">3D Semantik Analiz</div>
                </div>
            </div>
            <div style="position:relative;flex:1;max-width:420px;min-width:180px;">
                <input type="text" id="search-input" placeholder="Sure, koordinat veya meal ara..." class="hdr-search" style="width:100%;">
                <div id="search-results" class="search-results"></div>
            </div>
            <div class="header-actions">
                <label id="file-input-label" class="hdr-btn with-label" title="Veri Oku" style="cursor:pointer">
                    <span>ğŸ“„</span><span class="hdr-btn-label">VERÄ° OKU</span>
                    <input type="file" id="file-input" class="hidden" accept=".json">
                </label>
                <button onclick="openDatasets()" class="hdr-btn" title="Veri Setleri">ğŸ“‚</button>
                <button id="editor-btn-header" onclick="openEditor()" class="hdr-btn" title="JSON EditÃ¶r">ğŸ“</button>
                <button onclick="openNotes()" class="hdr-btn" title="NotlarÄ±m">ğŸ““</button>
                <div class="hdr-divider"></div>
                <button id="admin-btn" onclick="openAdmin()" class="hdr-btn" title="KullanÄ±cÄ± YÃ¶netimi" style="display:none">ğŸ‘¥</button>
                <div class="relative" id="layout-menu-wrap">
                    <button onclick="toggleLayoutMenu()" class="hdr-btn" title="Uzay YerleÅŸim Modeli" id="layout-btn">ğŸŒŒ</button>
                    <div id="layout-menu" class="hidden absolute right-0 top-full mt-2 bg-black/95 backdrop-blur-xl border border-white/10 rounded-2xl p-2 min-w-[220px] shadow-2xl z-[100]">
                        <button onclick="switchLayout('galaxy')" class="layout-option active" data-layout="galaxy">ğŸŒŒ Galaksi <span class="layout-desc">ArÅŸimed spirali â€” Samanyolu modeli</span></button>
                        <button onclick="switchLayout('nebula')" class="layout-option" data-layout="nebula">ğŸŒ«ï¸ Bulutsu <span class="layout-desc">Gauss bulut kÃ¼meleri â€” Organik daÄŸÄ±lÄ±m</span></button>
                        <button onclick="switchLayout('cube')" class="layout-option" data-layout="cube">ğŸ“¦ KÃ¼p <span class="layout-desc">3B Ä±zgara â€” Kristal yapÄ±</span></button>
                        <button onclick="switchLayout('sphere')" class="layout-option" data-layout="sphere">ğŸ”® KÃ¼re <span class="layout-desc">Fibonacci kÃ¼re â€” AltÄ±n oran daÄŸÄ±lÄ±mÄ±</span></button>
                    </div>
                </div>
                <button onclick="openSettings()" class="hdr-btn" title="Ayarlar">âš™ï¸</button>
            </div>
        </div>
    </div>

    <!-- WYSIWYG Notes Editor -->
    <div class="notes-overlay" id="notes-overlay">
        <div class="notes-panel">
            <div class="notes-header">
                <h3>ğŸ““ NotlarÄ±m</h3>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button onclick="addNewNote()" class="hdr-btn" title="Yeni Not" style="width:32px;height:32px;font-size:16px;">âœš</button>
                    <button onclick="deleteCurrentNote()" class="hdr-btn" title="Notu Sil" style="width:32px;height:32px;font-size:14px;color:#ef4444;">ğŸ—‘</button>
                    <button onclick="closeNotes()" class="hdr-btn" title="Kapat" style="width:32px;height:32px;">âœ•</button>
                </div>
            </div>
            <div class="notes-body">
                <div class="notes-sidebar" id="notes-sidebar"></div>
                <div class="notes-editor-area">
                    <input type="text" class="notes-title-input" id="note-title" placeholder="Not baÅŸlÄ±ÄŸÄ±..." oninput="autoSaveNote()">
                    <div class="notes-toolbar">
                        <button onclick="nCmd('bold')" title="KalÄ±n"><b>B</b></button>
                        <button onclick="nCmd('italic')" title="Ä°talik"><i>I</i></button>
                        <button onclick="nCmd('underline')" title="AltÄ± Ã‡izili"><u>U</u></button>
                        <button onclick="nCmd('strikeThrough')" title="ÃœstÃ¼ Ã‡izili"><s>S</s></button>
                        <div class="tb-sep"></div>
                        <button onclick="nCmd('formatBlock','H1')" title="BaÅŸlÄ±k 1" style="font-size:14px;font-weight:900;">H1</button>
                        <button onclick="nCmd('formatBlock','H2')" title="BaÅŸlÄ±k 2" style="font-size:12px;font-weight:800;">H2</button>
                        <button onclick="nCmd('formatBlock','H3')" title="BaÅŸlÄ±k 3" style="font-size:11px;font-weight:700;">H3</button>
                        <button onclick="nCmd('formatBlock','P')" title="Paragraf" style="font-size:11px;">Â¶</button>
                        <div class="tb-sep"></div>
                        <button onclick="nCmd('insertUnorderedList')" title="Madde Ä°ÅŸareti">â˜°</button>
                        <button onclick="nCmd('insertOrderedList')" title="NumaralÄ± Liste">â˜·</button>
                        <button onclick="nCmd('formatBlock','BLOCKQUOTE')" title="AlÄ±ntÄ±">â</button>
                        <div class="tb-sep"></div>
                        <button onclick="insertNoteLink()" title="BaÄŸlantÄ±">ğŸ”—</button>
                        <button onclick="nCmd('insertHTML','<code>kod</code>')" title="Kod">âŒ¨</button>
                        <button onclick="nCmd('removeFormat')" title="BiÃ§imlendirmeyi KaldÄ±r">ğŸš«</button>
                    </div>
                    <div class="notes-content" id="note-content" contenteditable="true" oninput="autoSaveNote()"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="hud-panel" class="fixed inset-2 top-16 md:inset-auto md:top-20 md:bottom-8 md:left-8 md:w-[28rem] hud-panel rounded-2xl md:rounded-[3.5rem] p-4 md:p-10 hidden z-40 overflow-y-auto overflow-x-hidden border border-white/5 transition-all duration-300" style="scrollbar-width:thin;scrollbar-color:#00f2ff transparent;">
        <button id="close-hud" class="absolute top-3 right-3 md:top-10 md:right-10 w-9 h-9 md:w-10 md:h-10 flex items-center justify-center bg-white/5 rounded-full text-slate-500 hover:text-white transition-all z-50">âœ•</button>
        <div id="hud-content">
            <div class="mb-6 md:mb-8 border-b border-white/10 pb-6 md:pb-8">
                <h2 id="hud-title" class="text-3xl md:text-4xl neon-title">SURE</h2>
                <p id="hud-coord" class="text-[9px] md:text-[10px] text-slate-500 font-mono tracking-[0.4em] mt-2 uppercase opacity-60">KOORDÄ°NAT: 0:0</p>
            </div>

            <div class="bg-slate-900/60 p-4 md:p-8 rounded-xl md:rounded-[2.5rem] mb-4 md:mb-8 border border-white/5 shadow-inner" style="overflow:hidden;word-break:break-word;">
                <p id="hud-arabic" class="text-right text-xl md:text-3xl arabic-text text-white leading-relaxed" dir="rtl" style="overflow-wrap:break-word;"></p>
                <div class="h-px w-full bg-cyan-400/20 my-3 md:my-6"></div>
                <p id="hud-translation" class="text-sm md:text-lg text-slate-200 italic font-light leading-relaxed" style="overflow-wrap:break-word;"></p>
                <div class="flex items-center gap-2 mt-3">
                    <button id="dipnot-toggle" onclick="toggleDipnot()" style="width:28px;height:28px;border-radius:50%;border:1px solid #f59e0b;background:rgba(245,158,11,0.1);color:#f59e0b;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:all 0.2s;" title="Dipnot">ğŸ“Œ</button>
                    <span id="dipnot-label" class="text-[10px] text-amber-600 font-bold uppercase tracking-widest">Dipnot</span>
                </div>
                <div id="hud-dipnot" class="hidden mt-3 bg-amber-950/30 border border-amber-400/20 rounded-xl p-4 text-sm text-amber-200/80 italic leading-relaxed"></div>
            </div>

            <div class="mb-6 md:mb-8">
                <h3 class="text-[8px] md:text-[9px] font-black text-slate-600 uppercase tracking-[0.4em] mb-4 md:mb-6 italic text-center">SÃ¼lÃ¢si KÃ¶k Analizi</h3>
                <div id="hud-roots" class="flex flex-wrap justify-center gap-2 md:gap-4" style="overflow:hidden;"></div>
                <div id="hud-root-stats" class="mt-4"></div>
            </div>

            <div class="mb-6 md:mb-8">
                <button id="ai-analyze-btn" onclick="analyzeWithAI()" class="w-full bg-gradient-to-r from-purple-950 to-cyan-950 hover:from-purple-800 hover:to-cyan-800 border border-purple-400/30 px-6 py-3 rounded-2xl font-black text-[11px] cursor-pointer shadow-xl transition-all uppercase text-white tracking-widest flex items-center justify-center gap-3">
                    <span class="text-lg">ğŸ¤–</span> Yapay ZekÃ¢ Analizi
                </button>
                <div id="ai-result" class="hidden mt-4 bg-purple-950/30 border border-purple-400/20 rounded-2xl p-5 text-sm text-slate-200 leading-relaxed"></div>
            </div>

            <div class="pb-8">
                <h3 class="text-[9px] font-black text-cyan-950 uppercase tracking-[0.4em] mb-4 italic text-center">Semantik BaÄŸlantÄ±lar</h3>
                <input type="text" id="hud-search" placeholder="Ayet, sure veya kÃ¶k ara..." class="w-full bg-black/60 border border-white/10 rounded-full px-5 py-2 mb-4 outline-none focus:border-cyan-400 text-xs text-white placeholder-slate-600 font-mono">
                <div id="related-list"></div>
            </div>
        </div>
    </div>

    <!-- Toast Bildirimleri -->
    <div id="toast-container" style="position:fixed;top:80px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;"></div>
    <!-- Ã‡evrimiÃ§i KullanÄ±cÄ±lar -->
    <div id="online-indicator" style="position:fixed;bottom:16px;left:16px;z-index:50;display:none;background:rgba(0,0,0,0.7);backdrop-filter:blur(12px);border:1px solid rgba(52,211,153,0.2);border-radius:20px;padding:6px 14px;font-size:10px;color:#34d399;font-weight:700;letter-spacing:0.1em;cursor:pointer;" onclick="showOnlineList()" title="Ã‡evrimiÃ§i kullanÄ±cÄ±lar">
        <span id="online-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#34d399;margin-right:6px;animation:pulse 2s infinite;"></span>
        <span id="online-count">0</span> Ã§evrimiÃ§i
    </div>

    <script>
        /** GLOBAL VARIABLES **/
        let scene, camera, renderer, ayahMesh, starField, lineSegments, controls, highlightLines;
        let nodes = []; let surahGroups = []; let ayahNodes = []; let rootMap = new Map(); let labelSprites = []; let lineNodePairs = []; let ayahIndexMap = [];
        let originalData = null; let hasCustomData = false;
        let currentLayout = 'galaxy';

        // Glow shader (fresnel atmosfer efekti)
        const glowVertexShader = `
            varying vec3 vNormal;
            varying vec3 vPositionNormal;
            void main() {
                vNormal = normalize(normalMatrix * normal);
                vPositionNormal = normalize((modelViewMatrix * vec4(position, 1.0)).xyz);
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `;
        const glowFragmentShader = `
            uniform vec3 glowColor;
            uniform float intensity;
            uniform float time;
            varying vec3 vNormal;
            varying vec3 vPositionNormal;
            void main() {
                float rim = pow(intensity - dot(vNormal, vPositionNormal), 3.0);
                float pulse = 0.85 + 0.15 * sin(time * 2.0);
                gl_FragColor = vec4(glowColor, rim * pulse);
            }
        `;
        // ProsedÃ¼rel neon gÃ¼l texture Ã¼retici (tortÃ¼lÃ¼/grainy)
        const createSunTexture = (baseColor, size) => {
            size = size || 512;
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            const cx = size / 2, cy = size / 2, r = size / 2;
            const R = baseColor.r * 255 | 0, G = baseColor.g * 255 | 0, B = baseColor.b * 255 | 0;

            // Koyu arka plan
            ctx.fillStyle = `rgb(${R * 0.08 | 0},${G * 0.08 | 0},${B * 0.15 | 0})`;
            ctx.fillRect(0, 0, size, size);

            // Merkez yumuÅŸak parlama
            const core = ctx.createRadialGradient(cx, cy, 0, cx, cy, r * 0.7);
            core.addColorStop(0, `rgba(${R * 0.4 | 0},${G * 0.4 | 0},${B * 0.6 | 0},0.6)`);
            core.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = core;
            ctx.fillRect(0, 0, size, size);

            // Neon girdap damarlarÄ± (gÃ¼l yapraklarÄ± benzeri)
            ctx.globalCompositeOperation = 'lighter';
            for (let i = 0; i < 18; i++) {
                ctx.beginPath();
                const startAngle = (i / 18) * Math.PI * 2 + Math.random() * 0.5;
                const spiralR = r * (0.2 + Math.random() * 0.6);
                let px = cx, py = cy;
                ctx.moveTo(px, py);
                for (let t = 0; t < 40; t++) {
                    const a = startAngle + t * 0.15 + Math.sin(t * 0.3) * 0.5;
                    const rd = spiralR * (t / 40);
                    px = cx + Math.cos(a) * rd + (Math.random() - 0.5) * 8;
                    py = cy + Math.sin(a) * rd + (Math.random() - 0.5) * 8;
                    ctx.lineTo(px, py);
                }
                const brightness = 0.5 + Math.random() * 0.5;
                ctx.strokeStyle = `rgba(${Math.min(255, R * 1.8) | 0},${Math.min(255, G * 1.8) | 0},${Math.min(255, B * 2) | 0},${brightness * 0.4})`;
                ctx.lineWidth = 1 + Math.random() * 2.5;
                ctx.shadowColor = `rgb(${Math.min(255, R * 1.5) | 0},${Math.min(255, G * 1.5) | 0},${Math.min(255, B * 2) | 0})`;
                ctx.shadowBlur = 6 + Math.random() * 10;
                ctx.stroke();
            }

            // Yaprak benzeri kavisli ÅŸekiller
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                const a0 = Math.random() * Math.PI * 2;
                const petalR = r * (0.3 + Math.random() * 0.4);
                const px0 = cx + Math.cos(a0) * petalR * 0.3;
                const py0 = cy + Math.sin(a0) * petalR * 0.3;
                const px1 = cx + Math.cos(a0 + 0.5) * petalR;
                const py1 = cy + Math.sin(a0 + 0.5) * petalR;
                const px2 = cx + Math.cos(a0 + 1.0) * petalR * 0.3;
                const py2 = cy + Math.sin(a0 + 1.0) * petalR * 0.3;
                ctx.moveTo(px0, py0);
                ctx.quadraticCurveTo(px1, py1, px2, py2);
                ctx.strokeStyle = `rgba(${Math.min(255, R * 1.6) | 0},${Math.min(255, G * 1.6) | 0},${Math.min(255, B * 2.2) | 0},${0.25 + Math.random() * 0.25})`;
                ctx.lineWidth = 1.5 + Math.random() * 2;
                ctx.shadowBlur = 12;
                ctx.stroke();
            }
            ctx.shadowBlur = 0;

            // Kenar neon parlamasÄ±
            const edge = ctx.createRadialGradient(cx, cy, r * 0.5, cx, cy, r);
            edge.addColorStop(0, 'rgba(0,0,0,0)');
            edge.addColorStop(0.7, `rgba(${R * 0.3 | 0},${G * 0.3 | 0},${B * 0.8 | 0},0.15)`);
            edge.addColorStop(1, `rgba(${Math.min(255, R * 1.2) | 0},${Math.min(255, G * 1.2) | 0},${Math.min(255, B * 1.5) | 0},0.4)`);
            ctx.fillStyle = edge;
            ctx.fillRect(0, 0, size, size);

            // TortÃ¼lÃ¼ / grainy noise
            const imgData = ctx.getImageData(0, 0, size, size);
            const d = imgData.data;
            for (let i = 0; i < d.length; i += 4) {
                const noise = (Math.random() - 0.5) * 30;
                d[i] = Math.max(0, Math.min(255, d[i] + noise));
                d[i+1] = Math.max(0, Math.min(255, d[i+1] + noise));
                d[i+2] = Math.max(0, Math.min(255, d[i+2] + noise));
            }
            ctx.putImageData(imgData, 0, 0);
            ctx.globalCompositeOperation = 'source-over';

            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            tex.needsUpdate = true;
            return tex;
        };

        let raycaster = new THREE.Raycaster(); let mouse = new THREE.Vector2();
        let currentAudio = null; let audioCache = new Map(); let hoverTimeout = null; let lastHoveredId = null;
        let warpActive = false; let warpProgress = 0; let warpStart = new THREE.Vector3(); let warpEnd = new THREE.Vector3(); let warpTarget = new THREE.Vector3();
        let warpCanvas, warpCtx, warpStars = [], warpSpeed = 1, warpCenterX = 0, warpCenterY = 0;
        let isAudioLoading = false;

        // --- API Key YÃ¶netimi (localStorage) ---
        const KeyManager = {
            _STORAGE_KEY: 'sgx_api_keys',
            _encode: (s) => btoa(unescape(encodeURIComponent(s))),
            _decode: (s) => { try { return decodeURIComponent(escape(atob(s))); } catch(e) { return ''; } },
            getKeys() {
                try {
                    const raw = localStorage.getItem(this._STORAGE_KEY);
                    if (!raw) return [];
                    return JSON.parse(this._decode(raw));
                } catch(e) { return []; }
            },
            saveKeys(keys) {
                localStorage.setItem(this._STORAGE_KEY, this._encode(JSON.stringify(keys)));
            },
            addKey(key) {
                const keys = this.getKeys();
                if (keys.find(k => k.key === key)) return false;
                keys.push({ key, status: 'pending' });
                this.saveKeys(keys);
                return true;
            },
            removeKey(key) {
                const keys = this.getKeys().filter(k => k.key !== key);
                this.saveKeys(keys);
            },
            updateStatus(key, status, error) {
                const keys = this.getKeys();
                const k = keys.find(x => x.key === key);
                if (k) { k.status = status; k.error = error || ''; this.saveKeys(keys); }
            },
            async testKey(key) {
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    if (r.ok) return { ok: true };
                    const err = await r.json().catch(() => null);
                    const msg = err?.error?.message || `HTTP ${r.status}`;
                    return { ok: false, error: msg };
                } catch(e) { return { ok: false, error: e.message }; }
            },
            async getWorkingKey() {
                const keys = this.getKeys();
                const sorted = [...keys].sort((a,b) => (a.status === 'ok' ? -1 : 1) - (b.status === 'ok' ? -1 : 1));
                for (const k of sorted) {
                    const result = await this.testKey(k.key);
                    this.updateStatus(k.key, result.ok ? 'ok' : 'fail');
                    if (result.ok) return k.key;
                }
                return null;
            }
        };
        let apiKey = null;

        // --- Kimlik DoÄŸrulama ---
        let authToken = localStorage.getItem('sgx_auth_token') || '';
        let authUser = '', authRole = '', isDesktopMode = false;
        const authFetch = (url, opts = {}) => {
            if (!opts.headers) opts.headers = {};
            if (authToken) opts.headers['Authorization'] = 'Bearer ' + authToken;
            return fetch(url, opts);
        };

        // --- Veri Seti YÃ¶netimi (Sunucu API + IndexedDB fallback) ---
        let currentUser = localStorage.getItem('sgx_username') || '';
        const DatasetStore = {
            _DB: 'sgx_ds', _STORE: 'ds', _db: null, _serverOk: null, _wsPort: null,
            async _checkServer() {
                if (this._serverOk !== null) return this._serverOk;
                try {
                    const r = await fetch('/api/info', { signal: AbortSignal.timeout(2000) });
                    this._serverOk = r.ok;
                    if (r.ok) {
                        try {
                            const info = await r.json();
                            this._wsPort = info.wsPort;
                        } catch {}
                    }
                } catch { this._serverOk = false; }
                return this._serverOk;
            },
            async _openDB() {
                if (this._db) return this._db;
                return new Promise((res, rej) => {
                    const r = indexedDB.open(this._DB, 1);
                    r.onupgradeneeded = e => e.target.result.createObjectStore(this._STORE, { keyPath: 'name' });
                    r.onsuccess = e => { this._db = e.target.result; res(this._db); };
                    r.onerror = e => rej(e);
                });
            },
            async save(name, data) {
                if (currentUser) {
                    if (!data._meta) data._meta = {};
                    data._meta.modifiedBy = currentUser;
                    data._meta.modifiedAt = new Date().toISOString();
                }
                if (await this._checkServer()) {
                    await authFetch('/api/dataset/' + encodeURIComponent(name), {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    const db = await this._openDB();
                    await new Promise((res, rej) => {
                        const tx = db.transaction(this._STORE, 'readwrite');
                        tx.objectStore(this._STORE).put({ name, data, date: new Date().toLocaleDateString('tr-TR') });
                        tx.oncomplete = () => res(); tx.onerror = e => rej(e);
                    });
                }
            },
            async get(name) {
                if (await this._checkServer()) {
                    try {
                        const r = await authFetch('/api/dataset/' + encodeURIComponent(name));
                        if (r.ok) { const data = await r.json(); return { name, data }; }
                    } catch {}
                }
                const db = await this._openDB();
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE).objectStore(this._STORE).get(name);
                    r.onsuccess = () => res(r.result); r.onerror = e => rej(e);
                });
            },
            async getAll() {
                if (await this._checkServer()) {
                    try {
                        const r = await authFetch('/api/datasets');
                        if (r.ok) {
                            const list = await r.json();
                            return list.map(d => ({ name: d.name, data: { nodes: [] }, date: d.date, nodeCount: d.nodeCount, modifiedBy: d.modifiedBy, sizeKB: d.sizeKB }));
                        }
                    } catch {}
                }
                const db = await this._openDB();
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE).objectStore(this._STORE).getAll();
                    r.onsuccess = () => res(r.result); r.onerror = e => rej(e);
                });
            },
            async remove(name) {
                if (await this._checkServer()) {
                    await authFetch('/api/dataset/' + encodeURIComponent(name), { method: 'DELETE' });
                } else {
                    const db = await this._openDB();
                    await new Promise((res, rej) => {
                        const tx = db.transaction(this._STORE, 'readwrite');
                        tx.objectStore(this._STORE).delete(name);
                        tx.oncomplete = () => res(); tx.onerror = e => rej(e);
                    });
                }
            },
            async isServer() { return this._checkServer(); }
        };
        let activeDatasetName = 'quran_data.json';

        const arabicToLatinMap = {
            'Ø§': 'E', 'Ø£': 'E', 'Ø¥': 'E', 'Ø¢': 'E', 'Ø¨': 'B', 'Øª': 'T', 'Ø«': 'TH', 'Ø¬': 'C', 'Ø­': 'H', 'Ø®': 'KH', 
            'Ø¯': 'D', 'Ø°': 'DH', 'Ø±': 'R', 'Ø²': 'Z', 'Ø³': 'S', 'Ø´': 'Å', 'Øµ': 'S', 
            'Ø¶': 'D', 'Ø·': 'T', 'Ø¸': 'Z', 'Ø¹': 'A', 'Øº': 'GH', 'Ù': 'F', 'Ù‚': 'K', 
            'Ùƒ': 'K', 'Ù„': 'L', 'Ù…': 'M', 'Ù†': 'N', 'Ù‡': 'H', 'Ùˆ': 'V', 'ÙŠ': 'Y', 
            'Ø¡': 'E', 'Ø¤': 'W', 'Ø¦': 'Y', 'Ø©': 'T', ' ' : '-'
        };

        const surahNamesTR = {
            "1":"FÃ¢tiha","2":"Bakara","3":"Ã‚l-i Ä°mrÃ¢n","4":"NisÃ¢","5":"MÃ¢ide","6":"En'Ã¢m","7":"A'rÃ¢f","8":"EnfÃ¢l","9":"Tevbe","10":"YÃ»nus",
            "11":"HÃ»d","12":"YÃ»suf","13":"Ra'd","14":"Ä°brÃ¢hÃ®m","15":"Hicr","16":"Nahl","17":"Ä°srÃ¢","18":"Kehf","19":"Meryem","20":"TÃ¢-HÃ¢",
            "21":"EnbiyÃ¢","22":"Hac","23":"MÃ¼'minÃ»n","24":"NÃ»r","25":"FurkÃ¢n","26":"ÅuarÃ¢","27":"Neml","28":"Kasas","29":"AnkebÃ»t","30":"RÃ»m",
            "31":"LokmÃ¢n","32":"Secde","33":"AhzÃ¢b","34":"Sebe'","35":"FÃ¢tÄ±r","36":"YÃ¢-SÃ®n","37":"SÃ¢ffÃ¢t","38":"SÃ¢d","39":"ZÃ¼mer","40":"MÃ¼'min",
            "41":"Fussilet","42":"ÅÃ»rÃ¢","43":"Zuhruf","44":"DuhÃ¢n","45":"CÃ¢siye","46":"AhkÃ¢f","47":"Muhammed","48":"Fetih","49":"HucurÃ¢t","50":"KÃ¢f",
            "51":"ZÃ¢riyÃ¢t","52":"TÃ»r","53":"Necm","54":"Kamer","55":"RahmÃ¢n","56":"VÃ¢kÄ±a","57":"HadÃ®d","58":"MÃ¼cÃ¢dele","59":"HaÅŸr","60":"MÃ¼mtehine",
            "61":"Saff","62":"Cuma","63":"MÃ¼nÃ¢fikÃ»n","64":"TegÃ¢bun","65":"TalÃ¢k","66":"TahrÃ®m","67":"MÃ¼lk","68":"Kalem","69":"HÃ¢kka","70":"MeÃ¢ric",
            "71":"NÃ»h","72":"Cin","73":"MÃ¼zzemmil","74":"MÃ¼ddessir","75":"KÄ±yÃ¢met","76":"Ä°nsÃ¢n","77":"MÃ¼rselÃ¢t","78":"Nebe","79":"NÃ¢ziÃ¢t","80":"Abese",
            "81":"TekvÃ®r","82":"Ä°nfitÃ¢r","83":"MutaffifÃ®n","84":"Ä°nÅŸikÃ¢k","85":"BurÃ»c","86":"TÃ¢rÄ±k","87":"A'lÃ¢","88":"GÃ¢ÅŸiye","89":"Fecr","90":"Beled",
            "91":"Åems","92":"Leyl","93":"DuhÃ¢","94":"Ä°nÅŸirÃ¢h","95":"TÃ®n","96":"Alak","97":"Kadir","98":"Beyyine","99":"ZilzÃ¢l","100":"Ã‚diyÃ¢t",
            "101":"KÃ¢ria","102":"TekÃ¢sÃ¼r","103":"Asr","104":"HÃ¼meze","105":"FÃ®l","106":"KureyÅŸ","107":"MÃ¢Ã»n","108":"Kevser","109":"KÃ¢firÃ»n","110":"Nasr",
            "111":"Mesed","112":"Ä°hlÃ¢s","113":"Felak","114":"NÃ¢s"
        };

        const getSurahTR = (id) => surahNamesTR[id.split(':')[0]] || "Sure " + id.split(':')[0];
        const getRootCSSColor = (root) => {
            let h = 0; for (let i = 0; i < root.length; i++) h = (h << 5) - h + root.charCodeAt(i);
            return `hsl(${Math.abs(h * 137.5) % 360}, 100%, 60%)`;
        };
        const getRootPron = (root) => {
            if(!root) return "";
            return root.split('').filter(c => c !== ' ').map(char => arabicToLatinMap[char] || char).join('-');
        };

        const highlightArabicText = (text, roots) => {
            if (!roots || roots.length === 0) return text;
            const diacritics = /[\u064B-\u0670\u065F\u06D6-\u06ED]/g;
            const normChar = c => {
                if ('\u0623\u0625\u0622\u0627\u0621\u0671'.includes(c)) return '\u0627';
                if ('\u064A\u0649\u0626'.includes(c)) return '\u064A';
                if (c === '\u0624') return '\u0648';
                return c;
            };
            const isWeak = c => '\u0627\u0648\u064A'.includes(c);
            const cleanNorm = s => {
                let r = '';
                for (let i = 0; i < s.length; i++) {
                    const c = s[i];
                    if (c === '\u0640') continue;
                    if (!c.match(diacritics)) r += normChar(c);
                }
                return r;
            };
            const subseqMatch = (word, root) => {
                let ri = 0;
                for (let wi = 0; wi < word.length && ri < root.length; wi++) {
                    if (word[wi] === root[ri]) ri++;
                    else if (isWeak(root[ri]) && isWeak(word[wi])) ri++;
                }
                return ri >= root.length;
            };
            const rootMatchesWord = (word, root) => {
                if (subseqMatch(word, root)) return true;
                for (let i = 0; i < root.length; i++) {
                    if (isWeak(root[i])) {
                        const reduced = root.slice(0, i) + root.slice(i + 1);
                        if (reduced.length >= 2 && subseqMatch(word, reduced)) return true;
                    }
                }
                return false;
            };
            const rootData = roots.filter(r => r).map(r => {
                const clean = cleanNorm(r.trim()).replace(/\s/g, '');
                return { orig: r, clean, color: getRootCSSColor(r) };
            }).filter(r => r.clean.length >= 2);
            let result = '', buf = '';
            for (let i = 0; i <= text.length; i++) {
                const ch = i < text.length ? text[i] : null;
                if (!ch || ch === ' ' || ch === '\u00A0') {
                    if (buf) {
                        const cw = cleanNorm(buf);
                        let matched = false;
                        if (cw.length >= 2) {
                            for (const rd of rootData) {
                                if (rootMatchesWord(cw, rd.clean)) {
                                    result += `<span class="root-highlight" style="color: ${rd.color}">${buf}</span>`;
                                    matched = true;
                                    break;
                                }
                            }
                        }
                        if (!matched) result += buf;
                        buf = '';
                    }
                    if (ch) result += ch;
                } else {
                    buf += ch;
                }
            }
            return result;
        };

        const stopAudio = () => { if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; } };
        const playAudio = (url) => { if (currentAudio) stopAudio(); currentAudio = new Audio(url); currentAudio.play().catch(e => {}); };

        const speakAyah = async (text) => {
            if (!apiKey) { apiKey = await KeyManager.getWorkingKey(); }
            if (!apiKey) return false;
            stopAudio();
            if (audioCache.has(text)) { playAudio(audioCache.get(text)); return true; }
            if (isAudioLoading) return false;
            isAudioLoading = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say in Turkish: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } } },
                        model: "gemini-2.5-flash-preview-tts"
                    })
                });
                if (!response.ok) {
                    KeyManager.updateStatus(apiKey, 'fail');
                    apiKey = await KeyManager.getWorkingKey();
                    return false;
                }
                const result = await response.json();
                const part = result.candidates?.[0]?.content?.parts?.[0];
                if (part?.inlineData?.data) {
                    const raw = window.atob(part.inlineData.data);
                    const pcm = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; i++) pcm[i] = raw.charCodeAt(i);
                    const url = URL.createObjectURL(new Blob([pcmToWav(pcm, 24000)], { type: 'audio/wav' }));
                    audioCache.set(text, url);
                    playAudio(url);
                    return true;
                }
                console.warn('TTS: Ses verisi alÄ±namadÄ±', result);
                return false;
            } catch (err) { console.error('TTS hata:', err); return false; } finally { isAudioLoading = false; }
        };

        const pcmToWav = (pcm, rate) => {
            const b = new ArrayBuffer(44 + pcm.length); const v = new DataView(b);
            const s = (o, str) => { for (let i = 0; i < str.length; i++) v.setUint8(o + i, str.charCodeAt(i)); };
            s(0, 'RIFF'); v.setUint32(4, 36 + pcm.length, true); s(8, 'WAVE'); s(12, 'fmt '); v.setUint32(16, 16, true);
            v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true);
            v.setUint16(32, 2, true); v.setUint16(34, 16, true); s(36, 'data'); v.setUint32(40, pcm.length, true);
            for (let i = 0; i < pcm.length; i++) v.setUint8(44 + i, pcm[i]); return b;
        };

        const init = () => {
            scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 1, 100000000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); document.body.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
            scene.add(new THREE.AmbientLight(0xffffff, 1.4));
            const starGeom = new THREE.BufferGeometry(); const starPos = [];
            for(let i=0; i<60000; i++) starPos.push((Math.random()-0.5)*60000000, (Math.random()-0.5)*60000000, (Math.random()-0.5)*60000000);
            starGeom.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            starField = new THREE.Points(starGeom, new THREE.PointsMaterial({ color: 0x888888, size: 1600, transparent: true, opacity: 0.5 }));
            scene.add(starField); camera.position.set(0, 10000000, 20000000);

            // Canvas2D Hyperspace warp sistemi
            warpCanvas = document.getElementById('warp-canvas');
            warpCtx = warpCanvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            warpCanvas.width = window.innerWidth * dpr;
            warpCanvas.height = window.innerHeight * dpr;
            warpCanvas.style.width = window.innerWidth + 'px';
            warpCanvas.style.height = window.innerHeight + 'px';
            warpCtx.scale(dpr, dpr);
            warpCenterX = window.innerWidth / 2;
            warpCenterY = window.innerHeight / 2;
            for (let i = 0; i < 6000; i++) {
                warpStars.push({
                    x: Math.random() * window.innerWidth * 4 - window.innerWidth * 2,
                    y: Math.random() * window.innerHeight * 4 - window.innerHeight * 2,
                    z: Math.random() * window.innerWidth,
                    pz: 0, size: Math.random() * 2.0 + 0.5
                });
            }
            scene.add(camera);
            renderer.domElement.addEventListener('click', onMouseClick); 
            window.addEventListener('mousemove', onMouseMove); 
            animate();
            
            // --- OTOMATÄ°K VERÄ° Ã‡EKME (GitHub Pages DesteÄŸi) ---
            fetchDataAutomatically();
        };

        const fetchDataAutomatically = async () => {
            try {
                const response = await fetch('quran_data.json');
                if (response.ok) {
                    const data = await response.json();
                    originalData = data;
                    processData(data);
                }
            } catch (e) {
                console.log("JSON bulunamadÄ±, manuel yÃ¼kleme bekleniyor.");
            } finally {
                hideLoadingScreen();
            }
        };

        const createTextSprite = (text, isSurah) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 64;
            ctx.font = `bold ${isSurah ? 40 : 30}px Inter, sans-serif`;
            ctx.fillStyle = isSurah ? '#00f2ff' : '#ffffff';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            const texture = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: texture, transparent: true, depthTest: false });
            const sprite = new THREE.Sprite(mat);
            const s = isSurah ? 5000 : 3000;
            sprite.scale.set(s, s * (canvas.height / canvas.width), 1);
            return sprite;
        };

        // DÃ¼nya-Ay Ã¶lÃ§eÄŸi: DÃ¼nya r=6371km, Ay r=1737km (0.27Ã—), mesafe=384400km (60Ã—DÃ¼nya r)
        // Sure (DÃ¼nya) = 1500, Ayet (Ay) = 400, yÃ¶rÃ¼nge mesafesi = 45000 (30Ã—sure r)
        const calcLayoutPositions = (surahIds, layoutType) => {
            const surahPosMap = {};
            let ayahScatterR, scatterThickness;

            switch(layoutType) {
                case 'galaxy': {
                    const totalTurns = 4;
                    const maxRadius = 25000000;
                    ayahScatterR = 60000;
                    scatterThickness = 300000;
                    surahIds.forEach((sid, sIdx) => {
                        const t = sIdx / Math.max(surahIds.length - 1, 1);
                        const theta = t * totalTurns * Math.PI * 2;
                        const r = t * maxRadius;
                        surahPosMap[sid] = { x: Math.cos(theta) * r, y: 0, z: Math.sin(theta) * r };
                    });
                    break;
                }
                case 'nebula': {
                    const clusterCount = 7;
                    const clusterSpread = 12000000;
                    const clusterRadius = 4000000;
                    ayahScatterR = 400000;
                    scatterThickness = 400000;
                    const clusters = [];
                    for (let i = 0; i < clusterCount; i++) {
                        const phi = Math.acos(1 - 2 * (i + 0.5) / clusterCount);
                        const theta = Math.PI * (1 + Math.sqrt(5)) * i;
                        clusters.push({
                            x: Math.sin(phi) * Math.cos(theta) * clusterSpread,
                            y: Math.sin(phi) * Math.sin(theta) * clusterSpread * 0.4,
                            z: Math.cos(phi) * clusterSpread
                        });
                    }
                    const gaussRand = () => {
                        let u = 0, v = 0;
                        while (u === 0) u = Math.random();
                        while (v === 0) v = Math.random();
                        return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
                    };
                    surahIds.forEach((sid, sIdx) => {
                        const ci = sIdx % clusterCount;
                        const cc = clusters[ci];
                        surahPosMap[sid] = {
                            x: cc.x + gaussRand() * clusterRadius,
                            y: cc.y + gaussRand() * clusterRadius * 0.3,
                            z: cc.z + gaussRand() * clusterRadius
                        };
                    });
                    break;
                }
                case 'cube': {
                    const dim = 5;
                    const spacing = 5000000;
                    ayahScatterR = 300000;
                    scatterThickness = 300000;
                    const offset = (dim - 1) / 2 * spacing;
                    surahIds.forEach((sid, sIdx) => {
                        const ix = sIdx % dim;
                        const iy = Math.floor(sIdx / dim) % dim;
                        const iz = Math.floor(sIdx / (dim * dim));
                        surahPosMap[sid] = {
                            x: ix * spacing - offset,
                            y: iy * spacing - offset,
                            z: iz * spacing - offset
                        };
                    });
                    break;
                }
                case 'sphere': {
                    const sphereRadius = 20000000;
                    ayahScatterR = 350000;
                    scatterThickness = 350000;
                    const golden = Math.PI * (3 - Math.sqrt(5));
                    surahIds.forEach((sid, sIdx) => {
                        const yNorm = 1 - (sIdx / Math.max(surahIds.length - 1, 1)) * 2;
                        const radH = Math.sqrt(1 - yNorm * yNorm);
                        const theta = golden * sIdx;
                        surahPosMap[sid] = {
                            x: Math.cos(theta) * radH * sphereRadius,
                            y: yNorm * sphereRadius,
                            z: Math.sin(theta) * radH * sphereRadius
                        };
                    });
                    break;
                }
            }
            return { surahPosMap, ayahScatterR, scatterThickness };
        };

        const toggleLayoutMenu = () => {
            const menu = document.getElementById('layout-menu');
            menu.classList.toggle('hidden');
            const close = (e) => {
                if (!document.getElementById('layout-menu-wrap').contains(e.target)) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', close);
                }
            };
            if (!menu.classList.contains('hidden')) setTimeout(() => document.addEventListener('click', close), 0);
        };

        const switchLayout = (type) => {
            currentLayout = type;
            document.querySelectorAll('.layout-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layout === type);
            });
            document.getElementById('layout-menu').classList.add('hidden');
            if (originalData) processData(originalData);
            else if (nodes.length > 0) processData({ nodes });
        };

        const processData = (data) => {
            if (!data || !data.nodes) return;
            surahGroups.forEach(g => scene.remove(g)); if(ayahMesh) scene.remove(ayahMesh); if(lineSegments) scene.remove(lineSegments);
             labelSprites.forEach(s => scene.remove(s));
             if (highlightLines) { highlightLines.forEach(l => scene.remove(l)); highlightLines = []; }
             surahGroups = []; ayahNodes = []; rootMap.clear(); labelSprites = []; lineNodePairs = [];
            nodes = data.nodes.map(n => ({ ...n, roots: Array.isArray(n.roots) ? n.roots : [], dipnot: n.dipnot || '' }));
            const surahIds = [...new Set(nodes.map(n => n.id.split(':')[0]))].sort((a,b) => parseInt(a)-parseInt(b));

            // Surah baÅŸÄ±na ayet sayÄ±sÄ±
            const surahAyahCounts = {};
            surahIds.forEach(sid => {
                surahAyahCounts[sid] = nodes.filter(n => n.id.split(':')[0] === sid).length;
            });

            // YerleÅŸim modeline gÃ¶re pozisyon hesapla
            const layout = calcLayoutPositions(surahIds, currentLayout);
            const surahPosMap = layout.surahPosMap;
            const ayahScatterR = layout.ayahScatterR;
            const scatterThickness = layout.scatterThickness;

            const lineV = []; const lineC = [];

            nodes.forEach((node, idx) => {
                const parts = node.id.split(':');
                const surahNum = parts[0];
                const ayahNum = parseInt(parts[1]);
                const sp = surahPosMap[surahNum];

                if (ayahNum === 1) {
                    node.x = sp.x; node.y = sp.y; node.z = sp.z;
                    const g = new THREE.Group();
                    g.position.set(node.x, node.y, node.z);
                    g.userData = { nodeData: node };
                    const c = new THREE.Color(getRootCSSColor(surahNum));
                    const sunTex = createSunTexture(c, 512);

                    // Ä°Ã§ Ã§ekirdek kÃ¼re (texture'lÄ±)
                    const coreMat = new THREE.MeshBasicMaterial({ map: sunTex });
                    const core = new THREE.Mesh(new THREE.SphereGeometry(1500, 64, 64), coreMat);
                    core.renderOrder = 2;
                    g.add(core);

                    // Glow katmanÄ± (fresnel blur efekti)
                    const glowMat = new THREE.ShaderMaterial({
                        uniforms: {
                            glowColor: { value: c },
                            intensity: { value: 0.45 },
                            time: { value: 0.0 }
                        },
                        vertexShader: glowVertexShader,
                        fragmentShader: glowFragmentShader,
                        side: THREE.BackSide,
                        blending: THREE.AdditiveBlending,
                        transparent: true,
                        depthWrite: false
                    });
                    const glow = new THREE.Mesh(new THREE.SphereGeometry(2000, 32, 32), glowMat);
                    glow.renderOrder = 0;
                    g.add(glow);

                    // DÄ±ÅŸ halo (yumuÅŸak parlama)
                    const haloMat = new THREE.ShaderMaterial({
                        uniforms: {
                            glowColor: { value: c },
                            intensity: { value: 0.25 },
                            time: { value: 0.0 }
                        },
                        vertexShader: glowVertexShader,
                        fragmentShader: glowFragmentShader,
                        side: THREE.BackSide,
                        blending: THREE.AdditiveBlending,
                        transparent: true,
                        depthWrite: false
                    });
                    const halo = new THREE.Mesh(new THREE.SphereGeometry(2800, 32, 32), haloMat);
                    halo.renderOrder = 0;
                    g.add(halo);

                    const sLabel = createTextSprite(`${surahNamesTR[surahNum]} ${surahNum}:1`, true);
                    sLabel.position.set(0, 4000, 0);
                    g.add(sLabel);
                    surahGroups.push(g); scene.add(g);
                } else {
                    // Ayetler: surenin etrafÄ±nda daÄŸÄ±lÄ±m (DÃ¼nya-Ay oranÄ±)
                    const angle = Math.random() * Math.PI * 2;
                    const dist = (Math.random() * 0.7 + 0.3) * ayahScatterR;
                    if (currentLayout === 'galaxy') {
                        const totalAyahs = surahAyahCounts[surahNum];
                        const isUpper = ayahNum <= Math.ceil(totalAyahs / 2);
                        node.x = sp.x + Math.cos(angle) * dist;
                        node.z = sp.z + Math.sin(angle) * dist;
                        node.y = sp.y + (isUpper ? 1 : -1) * (Math.random() * 0.8 + 0.2) * scatterThickness;
                    } else {
                        const phi = Math.acos(2 * Math.random() - 1);
                        node.x = sp.x + Math.sin(phi) * Math.cos(angle) * dist;
                        node.y = sp.y + Math.sin(phi) * Math.sin(angle) * dist;
                        node.z = sp.z + Math.cos(phi) * dist;
                    }
                    ayahNodes.push(node);
                }
                (node.roots || []).forEach(r => { if(!rootMap.has(r)) rootMap.set(r, []); rootMap.get(r).push(idx); });
            });

            // KÃ¶k baÄŸlantÄ± Ã§izgileri
            rootMap.forEach((ids, root) => {
                if (ids.length < 2) return;
                const color = new THREE.Color(getRootCSSColor(root));
                for (let i = 0; i < ids.length - 1; i++) {
                    const n1 = nodes[ids[i]]; const n2 = nodes[ids[i+1]];
                    lineV.push(n1.x, n1.y, n1.z, n2.x, n2.y, n2.z);
                    lineC.push(color.r, color.g, color.b, color.r, color.g, color.b);
                    lineNodePairs.push({ n1: n1.id, n2: n2.id, root: root });
                }
            });
            const lG = new THREE.BufferGeometry();
            lG.setAttribute('position', new THREE.Float32BufferAttribute(lineV, 3));
            lG.setAttribute('color', new THREE.Float32BufferAttribute(lineC, 3));
            const lineOpacity = currentLayout === 'galaxy' ? 0.02 : 0.05;
            lineSegments = new THREE.LineSegments(lG, new THREE.LineBasicMaterial({ vertexColors: true, transparent: true, opacity: lineOpacity }));
            lineSegments.renderOrder = 1; scene.add(lineSegments);

            // Ayet kÃ¼releri (surah rengine gÃ¶re renk + yÃ¼ksek kalite)
            const ayahGeo = new THREE.SphereGeometry(400, 48, 48);
            const ayahBaseTex = createSunTexture(new THREE.Color(0xffffff), 512);
            const ayahMat = new THREE.MeshBasicMaterial({ map: ayahBaseTex });
            ayahMesh = new THREE.InstancedMesh(ayahGeo, ayahMat, ayahNodes.length);
            ayahMesh.instanceColor = new THREE.InstancedBufferAttribute(new Float32Array(ayahNodes.length * 3), 3);
            const dum = new THREE.Object3D();
            ayahNodes.forEach((a, i) => {
                dum.position.set(a.x, a.y, a.z);
                dum.updateMatrix();
                ayahMesh.setMatrixAt(i, dum.matrix);
                const sid = a.id.split(':')[0];
                const c = new THREE.Color(getRootCSSColor(sid));
                ayahMesh.setColorAt(i, c);
            });
            ayahMesh.instanceColor.needsUpdate = true;
            scene.add(ayahMesh);
            ayahNodes.forEach(a => {
                const ap = a.id.split(':');
                const lbl = createTextSprite(`${surahNamesTR[ap[0]]} ${ap[0]}:${ap[1]}`, false);
                lbl.position.set(a.x, a.y + 1200, a.z);
                lbl.visible = false;
                labelSprites.push(lbl);
                scene.add(lbl);
            });
            setTimeout(() => { if(nodes.length > 0) warpTo(nodes[0]); }, 100);
        };

        const onMouseMove = (event) => {
            if (event.target.closest('#tooltip')) return;
            const hTarget = event.target.closest('.ref-hover');
            if (hTarget) {
                const n = nodes.find(x => x.id === hTarget.dataset.id);
                if (n) { showTooltip(n, event.clientX, event.clientY); return; }
            }
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intS = raycaster.intersectObjects(surahGroups, true);
            if (intS.length > 0) {
                let o = intS[0].object; while(o && !o.userData?.nodeData) o = o.parent;
                if(o) { showTooltip(o.userData.nodeData, event.clientX, event.clientY); return; }
            }
            if (ayahMesh) {
                const intA = raycaster.intersectObject(ayahMesh);
                if (intA.length > 0) { const n = ayahNodes[intA[0].instanceId]; if(n) { showTooltip(n, event.clientX, event.clientY); return; } }
            }
            // Ã–nce neon tube'lara bak (gÃ¶rÃ¼nen kalÄ±n Ã§izgiler)
            if (highlightLines && highlightLines.length > 0) {
                const tubes = highlightLines.filter(m => m.userData.pair);
                const intT = raycaster.intersectObjects(tubes);
                if (intT.length > 0) {
                    const pair = intT[0].object.userData.pair;
                    if (pair) { showLineTooltip(pair, event.clientX, event.clientY); return; }
                }
            }
            // Neon yoksa arka plan Ã§izgilerine bak
            if ((!highlightLines || highlightLines.length === 0) && lineSegments && lineNodePairs.length > 0) {
                raycaster.params.Line.threshold = 800;
                const intL = raycaster.intersectObject(lineSegments);
                if (intL.length > 0) {
                    const segIdx = Math.floor(intL[0].index / 2);
                    const pair = lineNodePairs[segIdx];
                    if (pair) { showLineTooltip(pair, event.clientX, event.clientY); return; }
                }
            }
            hideTooltip();
        };

        const onMouseClick = (event) => {
            if (warpActive || event.target.closest('.hud-panel') || event.target.closest('.search-results') || event.target.closest('#tooltip')) return;
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intS = raycaster.intersectObjects(surahGroups, true);
            if (intS.length > 0) {
                let o = intS[0].object; while(o && !o.userData?.nodeData) o = o.parent;
                if(o && o.userData.nodeData) { warpTo(o.userData.nodeData); return; }
            }
            // Ã–nce neon tube'lara bak
            if (highlightLines && highlightLines.length > 0) {
                const tubes = highlightLines.filter(m => m.userData.pair);
                const intT = raycaster.intersectObjects(tubes);
                if (intT.length > 0) {
                    const pair = intT[0].object.userData.pair;
                    if (pair) {
                        const nd1 = nodes.find(nd => nd.id === pair.n1);
                        const nd2 = nodes.find(nd => nd.id === pair.n2);
                        if (nd1 && nd2) {
                            const d1 = camera.position.distanceToSquared(new THREE.Vector3(nd1.x, nd1.y, nd1.z));
                            const d2 = camera.position.distanceToSquared(new THREE.Vector3(nd2.x, nd2.y, nd2.z));
                            hideTooltip();
                            warpTo(d1 <= d2 ? nd2 : nd1);
                            return;
                        }
                    }
                }
            }
            // Neon yoksa arka plan Ã§izgilerine bak
            if ((!highlightLines || highlightLines.length === 0) && lineSegments && lineNodePairs.length > 0) {
                raycaster.params.Line.threshold = 800;
                const intL = raycaster.intersectObject(lineSegments);
                if (intL.length > 0) {
                    const segIdx = Math.floor(intL[0].index / 2);
                    const pair = lineNodePairs[segIdx];
                    if (pair) {
                        const nd1 = nodes.find(nd => nd.id === pair.n1);
                        const nd2 = nodes.find(nd => nd.id === pair.n2);
                        if (nd1 && nd2) {
                            const d1 = camera.position.distanceToSquared(new THREE.Vector3(nd1.x, nd1.y, nd1.z));
                            const d2 = camera.position.distanceToSquared(new THREE.Vector3(nd2.x, nd2.y, nd2.z));
                            hideTooltip();
                            warpTo(d1 <= d2 ? nd2 : nd1);
                            return;
                        }
                    }
                }
            }
            let closestNode = null; let minDistance = 2500;
            nodes.forEach(n => {
                const nodePos = new THREE.Vector3(n.x, n.y, n.z);
                const distance = raycaster.ray.distanceToPoint(nodePos);
                if (distance < minDistance) { minDistance = distance; closestNode = n; }
            });
            if (closestNode) warpTo(closestNode);
        };

        const clampTooltip = (tooltip, x, y) => {
            const tw = tooltip.offsetWidth; const th = tooltip.offsetHeight;
            const vw = window.innerWidth; const vh = window.innerHeight;
            let tx = x + 25; let ty = y + 25;
            if (tx + tw > vw - 16) tx = vw - tw - 16;
            if (ty + th > vh - 16) ty = vh - th - 16;
            if (tx < 16) tx = 16; if (ty < 16) ty = 16;
            tooltip.style.left = tx + 'px'; tooltip.style.top = ty + 'px';
        };

        const showTooltip = (n, x, y) => {
            const tooltip = document.getElementById('tooltip');
            if (lastHoveredId === n.id) { if (!tooltip.matches(':hover')) clampTooltip(tooltip, x, y); return; }
            lastHoveredId = n.id;
            const highlightedText = highlightArabicText(n.text, n.roots);
            
            const rootsHtml = (n.roots || []).map(r => {
                const color = getRootCSSColor(r);
                return `
                    <div class="mini-root-tag" style="color: ${color}; border-color: ${color.replace('hsl', 'hsla').replace(')', ', 0.4)')}">
                        <span class="text-[18px] font-bold">${r}</span>
                        <span class="mini-root-pron">${getRootPron(r)}</span>
                    </div>`;
            }).join('');

            tooltip.innerHTML = `
                <div class='tooltip-header'><span class='text-[10px] font-black text-cyan-400 uppercase tracking-widest italic'>${getSurahTR(n.id)} ${n.id.split(':')[1]}</span></div>
                <p class='text-right arabic-text text-xl text-white mb-2' dir='rtl' style='word-break:break-word;overflow-wrap:break-word;'>${highlightedText}</p>
                <div class="flex flex-wrap gap-1 mb-3">
                    ${rootsHtml}
                </div>
                <div class='h-px w-full bg-cyan-400/20 my-3'></div>
                <p class='text-[13px] leading-relaxed text-slate-300 italic' style='word-break:break-word;overflow-wrap:break-word;'>${n.translation}</p>
            `;
            tooltip.style.display = 'block';
            tooltip.style.pointerEvents = 'auto';
            clampTooltip(tooltip, x, y);
        };
        const showLineTooltip = (pair, x, y) => {
            const tooltip = document.getElementById('tooltip');
            const rootColor = getRootCSSColor(pair.root);
            const rootPron = getRootPron(pair.root);
            const s1 = pair.n1.split(':'); const s2 = pair.n2.split(':');
            const name1 = `${surahNamesTR[s1[0]]} ${s1[0]}:${s1[1]}`;
            const name2 = `${surahNamesTR[s2[0]]} ${s2[0]}:${s2[1]}`;
            // Kameraya yakÄ±n olan node = bulunduÄŸun yer, uzak olan = gidilecek yer
            const nd1 = nodes.find(nd => nd.id === pair.n1);
            const nd2 = nodes.find(nd => nd.id === pair.n2);
            let farId, farName, nearName;
            if (nd1 && nd2) {
                const d1 = camera.position.distanceToSquared(new THREE.Vector3(nd1.x, nd1.y, nd1.z));
                const d2 = camera.position.distanceToSquared(new THREE.Vector3(nd2.x, nd2.y, nd2.z));
                if (d1 <= d2) { farId = pair.n2; farName = name2; nearName = name1; }
                else { farId = pair.n1; farName = name1; nearName = name2; }
            } else { farId = pair.n2; farName = name2; nearName = name1; }
            lastHoveredId = 'line_' + pair.n1 + '_' + pair.n2;
            tooltip.innerHTML = `
                <div style="font-size:11px;font-weight:900;color:#00f2ff;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px;">KÃ¶k BaÄŸlantÄ±sÄ±</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <span style="color:${rootColor};font-size:20px;font-weight:bold;">${pair.root}</span>
                    <span style="color:${rootColor};font-size:12px;opacity:0.7;">${rootPron}</span>
                </div>
                <div style="font-size:10px;color:#64748b;margin-bottom:6px;">ğŸ“ ${nearName}</div>
                <div onclick="hideTooltip();warpToId('${farId}')" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,242,255,0.08);border:1px solid rgba(0,242,255,0.2);border-radius:8px;cursor:pointer;transition:background 0.2s;" onmouseenter="this.style.background='rgba(0,242,255,0.2)'" onmouseleave="this.style.background='rgba(0,242,255,0.08)'"><span style="color:#00f2ff;font-size:8px;">â¬¤</span><span style="color:#e2e8f0;font-size:13px;font-weight:600;">â†’ ${farName}</span></div>`;
            tooltip.style.display = 'block';
            tooltip.style.pointerEvents = 'auto';
            clampTooltip(tooltip, x, y);
        };

        const hideTooltip = () => { const t = document.getElementById('tooltip'); t.style.display = 'none'; t.style.pointerEvents = 'none'; lastHoveredId = null; clearTimeout(hoverTimeout); stopAudio(); };
        window.hideTooltip = hideTooltip;

        let currentHudNode = null;
        let activeSpeakBtn = null;

        const speakWithBrowser = (text) => {
            if (!window.speechSynthesis) return false;
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'tr-TR';
            utter.rate = 0.9;
            window.speechSynthesis.speak(utter);
            return utter;
        };

        window.speakThis = async (btn, nodeId) => {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            if (!apiKey) { apiKey = await KeyManager.getWorkingKey(); }
            if (!apiKey) { showApiKeyGuide(); return; }
            const text = node.translation;
            if (activeSpeakBtn && activeSpeakBtn !== btn) { activeSpeakBtn.textContent = 'â–¶'; }
            if (currentAudio || window.speechSynthesis?.speaking) {
                stopAudio();
                window.speechSynthesis?.cancel();
                btn.textContent = 'â–¶';
                activeSpeakBtn = null;
                return;
            }
            activeSpeakBtn = btn;
            btn.textContent = 'â³';
            const success = await speakAyah(text);
            if (success && currentAudio) {
                btn.textContent = 'â¹';
                currentAudio.onended = () => { btn.textContent = 'â–¶'; currentAudio = null; activeSpeakBtn = null; };
                currentAudio.onerror = () => { btn.textContent = 'â–¶'; currentAudio = null; activeSpeakBtn = null; };
            } else {
                // Gemini TTS baÅŸarÄ±sÄ±z (Ã¼cretsiz key) â†’ tarayÄ±cÄ± TTS
                const utter = speakWithBrowser(text);
                if (utter) {
                    btn.textContent = 'â¹';
                    utter.onend = () => { btn.textContent = 'â–¶'; activeSpeakBtn = null; };
                    utter.onerror = () => { btn.textContent = 'â–¶'; activeSpeakBtn = null; };
                } else {
                    btn.textContent = 'âŒ';
                    setTimeout(() => { btn.textContent = 'â–¶'; }, 2000);
                    activeSpeakBtn = null;
                }
            }
        };

        const updateHighlightLines = (n) => {
            if (highlightLines) { highlightLines.forEach(m => scene.remove(m)); highlightLines = null; }
            if (!n) return;
            highlightLines = [];
            const nodeIdx = nodes.findIndex(nd => nd.id === n.id);
            (n.roots || []).forEach(root => {
                const ids = rootMap.get(root);
                if (!ids) return;
                const color = new THREE.Color(getRootCSSColor(root));
                for (let i = 0; i < ids.length - 1; i++) {
                    if (ids[i] === nodeIdx || ids[i+1] === nodeIdx) {
                        const a = nodes[ids[i]]; const b = nodes[ids[i+1]];
                        const p1 = new THREE.Vector3(a.x, a.y, a.z);
                        const p2 = new THREE.Vector3(b.x, b.y, b.z);
                        const path = new THREE.LineCurve3(p1, p2);
                        const pairData = { n1: a.id, n2: b.id, root: root };
                        const tubeR = currentLayout === 'galaxy' ? 40 : 150;
                        const tubeG = new THREE.TubeGeometry(path, 1, tubeR, 6, false);
                        const tubeM = new THREE.Mesh(tubeG, new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.85 }));
                        tubeM.renderOrder = 2;
                        tubeM.userData.pair = pairData;
                        scene.add(tubeM);
                        highlightLines.push(tubeM);
                        const glowG = new THREE.TubeGeometry(path, 1, tubeR * 1.8, 6, false);
                        const glowM = new THREE.Mesh(glowG, new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.06, blending: THREE.AdditiveBlending, depthWrite: false }));
                        glowM.renderOrder = 1;
                        scene.add(glowM);
                        highlightLines.push(glowM);
                    }
                }
            });
        };

        const showHUD = (n) => {
            if (!n) return;
            currentHudNode = n;
            // Ã–nceki ses/audio state'ini temizle
            stopAudio();
            isAudioLoading = false;
            activeSpeakBtn = null;
            updateHighlightLines(n);
            const panel = document.getElementById('hud-panel');
            panel.classList.remove('hidden');
            const arabicHighlighted = highlightArabicText(n.text, n.roots);
            document.getElementById('hud-title').innerText = getSurahTR(n.id);
            document.getElementById('hud-coord').innerText = `KOORDÄ°NAT: ${n.id}`;
            document.getElementById('hud-translation').innerText = n.translation;
            document.getElementById('hud-arabic').innerHTML = arabicHighlighted;

            // Dipnot alanÄ±nÄ± gÃ¼ncelle
            const dipnotDiv = document.getElementById('hud-dipnot');
            const dipnotLabel = document.getElementById('dipnot-label');
            dipnotDiv.classList.add('hidden');
            if (n.dipnot) {
                dipnotDiv.textContent = n.dipnot;
                dipnotLabel.textContent = 'Dipnot';
            } else {
                dipnotDiv.textContent = 'Bu ayet iÃ§in dipnot bulunmuyor.';
                dipnotLabel.textContent = 'Dipnot';
            }

            // Ã–nceki AI sonucunu temizle
            const aiResult = document.getElementById('ai-result');
            aiResult.classList.add('hidden');
            aiResult.innerHTML = '';

            const rootsCont = document.getElementById('hud-roots'); rootsCont.innerHTML = '';
            (n.roots || []).forEach(r => {
                const c = getRootCSSColor(r); const badge = document.createElement('div'); badge.className = "root-badge";
                badge.style.color = c; badge.style.borderColor = c.replace('hsl', 'hsla').replace(')', ', 0.4)');
                badge.style.backgroundColor = c.replace('hsl', 'hsla').replace(')', ', 0.1)');
                badge.innerHTML = `<span dir="rtl" class="text-2xl font-bold">${r}</span><span class="root-pron">${getRootPron(r)}</span>`;
                rootsCont.appendChild(badge);
            });

            // KÃ¶k istatistikleri
            const statsDiv = document.getElementById('hud-root-stats');
            let statsHtml = '';
            (n.roots || []).forEach(r => {
                const ids = rootMap.get(r) || [];
                const totalAyah = ids.length;
                const surahSet = new Set(ids.map(i => nodes[i].id.split(':')[0]));
                const totalSurah = surahSet.size;
                const c = getRootCSSColor(r);
                // Sure bazlÄ± daÄŸÄ±lÄ±m (en Ã§ok geÃ§en 5)
                const surahCounts = {};
                ids.forEach(i => { const sid = nodes[i].id.split(':')[0]; surahCounts[sid] = (surahCounts[sid] || 0) + 1; });
                const topSurahs = Object.entries(surahCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
                const barMax = topSurahs[0]?.[1] || 1;
                statsHtml += `
                    <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid ${c.replace('hsl', 'hsla').replace(')', ',0.15)')};border-radius:12px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span dir="rtl" style="color:${c};font-size:18px;font-weight:bold;">${r}</span>
                            <span style="color:${c};font-size:10px;opacity:0.7;">${getRootPron(r)}</span>
                            <span style="margin-left:auto;font-size:9px;color:#64748b;">Kur'an geneli</span>
                        </div>
                        <div style="display:flex;gap:16px;margin-bottom:8px;">
                            <div style="text-align:center;">
                                <div style="font-size:20px;font-weight:900;color:${c};">${totalAyah}</div>
                                <div style="font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.1em;">Ayet</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:20px;font-weight:900;color:${c};">${totalSurah}</div>
                                <div style="font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.1em;">Sure</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:20px;font-weight:900;color:${c};">${(totalAyah / 6236 * 100).toFixed(1)}%</div>
                                <div style="font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.1em;">Oran</div>
                            </div>
                        </div>
                        <div style="font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:4px;">En Ã‡ok GeÃ§tiÄŸi Sureler</div>
                        ${topSurahs.map(([sid, cnt]) => `
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
                                <span style="font-size:10px;color:#94a3b8;min-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${surahNamesTR[sid]}</span>
                                <div style="flex:1;height:6px;background:rgba(255,255,255,0.04);border-radius:3px;overflow:hidden;">
                                    <div style="width:${cnt / barMax * 100}%;height:100%;background:${c};border-radius:3px;opacity:0.6;"></div>
                                </div>
                                <span style="font-size:9px;color:${c};font-weight:700;min-width:20px;text-align:right;">${cnt}</span>
                            </div>`).join('')}
                    </div>`;
            });
            statsDiv.innerHTML = statsHtml;

            const list = document.getElementById('related-list'); list.innerHTML = '';
            const related = []; const seen = new Set([n.id]);
            const nIdx = nodes.findIndex(nd => nd.id === n.id);
            (n.roots || []).forEach(r => {
                const ids = rootMap.get(r);
                if (!ids) return;
                for (let i = 0; i < ids.length - 1; i++) {
                    if (ids[i] === nIdx || ids[i+1] === nIdx) {
                        const neighborIdx = ids[i] === nIdx ? ids[i+1] : ids[i];
                        const rn = nodes[neighborIdx];
                        if (rn && !seen.has(rn.id)) { related.push(rn); seen.add(rn.id); }
                    }
                }
            });
            
            let html = '';
            const grouped = related.reduce((acc, rn) => { const t = getSurahTR(rn.id); if (!acc[t]) acc[t] = []; acc[t].push(rn); return acc; }, {});
            for (const sName in grouped) {
                html += `<div class="surah-group-header"><span>${sName}</span><span>${grouped[sName].length} Ayet</span></div>`;
                grouped[sName].forEach(rn => {
                    const shared = (rn.roots || []).filter(r => (n.roots || []).includes(r));
                    html += `
                        <div class="ayah-list-item ref-hover" data-id="${rn.id}" onclick="event.stopPropagation(); warpToId('${rn.id}')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[11px] font-bold text-slate-100 uppercase tracking-tight">${getSurahTR(rn.id)} ${rn.id.split(':')[1]}. Ayet</span>
                                <div style="display:flex;align-items:center;gap:6px;">
                                    <button onclick="event.stopPropagation(); window.showDipnotPopup(this, '${rn.id}')" style="width:28px;height:28px;border-radius:50%;border:1px solid #f59e0b;background:rgba(245,158,11,0.1);color:#f59e0b;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;" title="Dipnot">ğŸ“Œ</button>
                                    <button onclick="event.stopPropagation(); window.speakThis(this, '${rn.id}')" style="width:28px;height:28px;border-radius:50%;border:1px solid #00f2ff;background:rgba(0,242,255,0.1);color:#00f2ff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;" title="Seslendir">â–¶</button>
                                    <span class="text-[10px] text-cyan-500 font-mono">${rn.id}</span>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                ${shared.map(sr => `
                                    <div class="mini-root-tag" style="color: ${getRootCSSColor(sr)}; border-color: ${getRootCSSColor(sr).replace('hsl', 'hsla').replace(')', ', 0.4)')}">
                                        <span>${sr}</span>
                                        <span class="mini-root-pron">${getRootPron(sr)}</span>
                                    </div>`).join('')}
                            </div>
                        </div>`;
                });
            }
            list.innerHTML = html || '<p class="text-xs text-slate-600 italic text-center">BaÄŸlantÄ± bulunamadÄ±.</p>';

            // HUD arama filtreleme
            const hudSearch = document.getElementById('hud-search');
            hudSearch.value = '';
            hudSearch.oninput = () => {
                const q = hudSearch.value.toLowerCase().trim();
                const items = list.querySelectorAll('.ayah-list-item');
                const headers = list.querySelectorAll('.surah-group-header');
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(q) ? '' : 'none';
                });
                // Sure baÅŸlÄ±klarÄ±nÄ±, altÄ±ndaki tÃ¼m ayetler gizliyse gizle
                headers.forEach(h => {
                    let next = h.nextElementSibling;
                    let anyVisible = false;
                    while (next && !next.classList.contains('surah-group-header')) {
                        if (next.style.display !== 'none') anyVisible = true;
                        next = next.nextElementSibling;
                    }
                    h.style.display = anyVisible ? '' : 'none';
                });
            };
        };

        const warpTo = (node) => { 
            if(!node) return;
            hideTooltip();
            warpActive = true; warpProgress = 0; controls.enabled = false; 
            warpStart.copy(camera.position); warpTarget.set(node.x, node.y, node.z); 
            warpEnd.set(node.x + 4000, node.y + 8000, node.z + 12000);
            showHUD(node); 
        };
        window.warpToId = (id) => { const t = nodes.find(n => n.id === id); if(t) warpTo(t); };
        let _lastFrameTime = 0;
        const animate = (now) => {
            requestAnimationFrame(animate);
            if (!now) now = performance.now();
            const dt = _lastFrameTime ? Math.min((now - _lastFrameTime) * 0.001, 0.05) : 0.016;
            _lastFrameTime = now;
            if (warpActive) {
                warpProgress += dt * 1.5; const p = Math.min(warpProgress, 1);
                const ease = p < 0.5 ? 4 * p * p * p : 1 - Math.pow(-2 * p + 2, 3) / 2;
                const w = window.innerWidth, h = window.innerHeight;

                // Canvas2D hyperspace (batched â€” 4 stroke Ã§aÄŸrÄ±sÄ±)
                if (p < 1) {
                    warpCanvas.style.display = 'block';
                    warpSpeed = 1 + Math.sin(p * Math.PI) * 120;
                    warpCtx.fillStyle = `rgba(0,0,0,${warpSpeed > 30 ? 0.12 : 0.3})`;
                    warpCtx.fillRect(0, 0, w, h);

                    for (let i = 0; i < warpStars.length; i++) {
                        const s = warpStars[i];
                        s.pz = s.z; s.z -= warpSpeed;
                        if (s.z < 1) { s.z = w; s.x = Math.random() * w * 4 - w * 2; s.y = Math.random() * h * 4 - h * 2; s.pz = s.z; }
                    }
                    warpCtx.lineCap = 'round';
                    const _bA = [0.3, 0.5, 0.7, 0.9];
                    const _bW = [0.6, 1.2, 1.8, 2.5];
                    for (let b = 0; b < 4; b++) {
                        warpCtx.strokeStyle = `rgba(255,255,255,${_bA[b]})`;
                        warpCtx.lineWidth = _bW[b];
                        warpCtx.beginPath();
                        for (let i = 0; i < warpStars.length; i++) {
                            const s = warpStars[i];
                            const dr = 1 - s.z / w;
                            if (Math.min(3, Math.max(0, dr * 4 | 0)) !== b) continue;
                            warpCtx.moveTo((s.x / s.pz) * w + warpCenterX, (s.y / s.pz) * h + warpCenterY);
                            warpCtx.lineTo((s.x / s.z) * w + warpCenterX, (s.y / s.z) * h + warpCenterY);
                        }
                        warpCtx.stroke();
                    }
                }

                // FOV
                if (p < 0.25) {
                    camera.fov = 65 + (p / 0.25) * 60;
                } else if (p < 0.75) {
                    camera.fov = 125;
                } else {
                    camera.fov = 125 - ((p - 0.75) / 0.25) * 60;
                }
                camera.updateProjectionMatrix();

                // Kamera hareketi
                camera.position.lerpVectors(warpStart, warpEnd, ease);
                controls.target.copy(warpTarget);

                if (p >= 1) {
                    warpActive = false; controls.enabled = true;
                    camera.fov = 65; camera.updateProjectionMatrix();
                    warpCtx.clearRect(0, 0, w, h);
                    warpCanvas.style.display = 'none';
                }
            }
            if (controls) controls.update();

            const elapsed = now * 0.001;
            if (!warpActive) {
                // Surah kÃ¼relerini dÃ¶ndÃ¼r + glow shader time gÃ¼ncelle
                surahGroups.forEach((g, i) => {
                    g.children.forEach(child => {
                        if (child.isMesh && child.material.uniforms && child.material.uniforms.time) {
                            child.material.uniforms.time.value = elapsed + i * 0.5;
                        }
                        if (child.isMesh && child.material.map) {
                            child.rotation.y = elapsed * 0.3 + i;
                            child.rotation.x = Math.sin(elapsed * 0.15 + i) * 0.2;
                        }
                    });
                });

                // Ayet node'larÄ±nÄ± dÃ¶ndÃ¼r (UV offset ile)
                if (ayahMesh && ayahMesh.material.map) {
                    ayahMesh.material.map.offset.x = elapsed * 0.05;
                    ayahMesh.material.map.offset.y = Math.sin(elapsed * 0.08) * 0.1;
                }

                const camP = camera.position;
                labelSprites.forEach(s => { s.visible = camP.distanceTo(s.position) < 25000; });
            }
            if (renderer) renderer.render(scene, camera);
        };
        
        document.getElementById('search-input').oninput = (e) => {
            const qRaw = e.target.value.trim();
            const results = document.getElementById('search-results');
            if (qRaw.length < 1) { results.style.display = 'none'; return; }
            const normalize = (s) => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[\u00e2\u00e0\u00e1]/g, 'a').replace(/[\u00ee\u00ef\u00ec\u00ed]/g, 'i').replace(/[\u00fb\u00fc\u00f9\u00fa]/g, 'u').replace(/[\u00f4\u00f6\u00f2\u00f3]/g, 'o').replace(/[\u00ea\u00eb\u00e8\u00e9]/g, 'e');
            const qNorm = normalize(qRaw);
            const parts = qRaw.split(/[\s:]+/);
            const searchSurah = parts[0]; const searchAyah = parts[1] || "";
            let finalResults = [];
            let matchCounts = { total: 0, surahs: new Set() };

            Object.keys(surahNamesTR).forEach(id => {
                const sNameNorm = normalize(surahNamesTR[id]);
                if (id === searchSurah || sNameNorm.includes(qNorm)) {
                    if (searchAyah) {
                        const fullId = `${id}:${searchAyah}`;
                        const ayahNode = nodes.find(n => n.id === fullId);
                        if (ayahNode) { finalResults.push({ id: fullId, label: `${surahNamesTR[id]} ${searchAyah}`, sub: "AYET", type: 'ayah' }); matchCounts.total++; matchCounts.surahs.add(id); }
                    } else finalResults.push({ id: id, label: `${surahNamesTR[id]}`, sub: "SURE", type: 'surah' });
                }
            });
            nodes.filter(n => normalize(n.translation).includes(qNorm)).forEach(n => {
                if (!finalResults.find(r => r.id === n.id)) finalResults.push({ id: n.id, label: `${getSurahTR(n.id)} ${n.id.split(':')[1]}`, sub: n.translation.substring(0, 50) + "...", type: 'ayah' });
                matchCounts.total++; matchCounts.surahs.add(n.id.split(':')[0]);
            });
            if (finalResults.length > 0) {
                let statsHtml = `<div class="search-stats-bar"><span>ğŸ” ${matchCounts.total} AYET</span><span>ğŸ“ ${matchCounts.surahs.size} SURE</span></div>`;
                results.innerHTML = statsHtml + finalResults.slice(0, 200).map(r => `
                    <div class="search-item" onmousedown="selectSearch('${r.id}', '${r.type}')">
                        <div class="flex flex-col"><span class="font-bold text-slate-100 text-sm uppercase italic">${r.label}</span><span class="text-[9px] text-cyan-500 font-bold opacity-60 mt-0.5 tracking-wider">${r.sub}</span></div>
                    </div>`).join('');
                results.style.display = 'block';
            } else results.style.display = 'none';
        };
        window.selectSearch = (targetId, type) => {
            let t = (type === 'ayah') ? nodes.find(n => n.id === targetId) : nodes.find(n => n.id.split(':')[0] === targetId);
            if (t) { warpTo(t); document.getElementById('search-results').style.display = 'none'; }
        };

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const fname = file.name;
            const r = new FileReader();
            r.onload = async (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    await DatasetStore.save(fname, data);
                    activeDatasetName = fname;
                    processData(data);
                    hasCustomData = true;
                } catch(err) { alert('GeÃ§ersiz JSON: ' + err.message); }
            };
            r.readAsText(file);
            e.target.value = '';
        };
        window.resetToOriginal = () => {
            if (!originalData) return;
            activeDatasetName = 'quran_data.json';
            processData(originalData);
            hasCustomData = false;
        };
        window.analyzeWithAI = async () => {
            if (!currentHudNode) return;
            if (!apiKey) { apiKey = await KeyManager.getWorkingKey(); }
            if (!apiKey) { showApiKeyGuide(); return; }
            const btn = document.getElementById('ai-analyze-btn');
            const result = document.getElementById('ai-result');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">â³</span> Analiz ediliyor...';
            result.classList.remove('hidden');
            result.innerHTML = '<p class="text-purple-400 animate-pulse text-center">Yapay zekÃ¢ dÃ¼ÅŸÃ¼nÃ¼yor...</p>';
            const n = currentHudNode;
            const roots = (n.roots || []).map(r => `${r} (${getRootPron(r)})`).join(', ');
            const prompt = `Sen bir Kur'an-Ä± Kerim semantik analiz uzmanÄ±sÄ±n. AÅŸaÄŸÄ±daki ayeti analiz et.

Sure: ${getSurahTR(n.id)}
Ayet: ${n.id}
ArapÃ§a: ${n.text}
Meal: ${n.translation}
KÃ¶kler: ${roots}

LÃ¼tfen ÅŸunlarÄ± yap:
1. Ayetin kÄ±sa tefsir Ã¶zeti (2-3 cÃ¼mle)
2. KÃ¶klerin semantik baÄŸlantÄ±larÄ± ve anlam katmanlarÄ±
3. Bu kÃ¶klerin Kur'an genelindeki kullanÄ±m kalÄ±plarÄ±
4. Ayetin mesajÄ±nÄ±n gÃ¼nÃ¼mÃ¼ze yansÄ±masÄ± (1-2 cÃ¼mle)

TÃ¼rkÃ§e yaz, kÄ±sa ve Ã¶z tut.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    result.innerHTML = text
                        .replace(/\*\*(.+?)\*\*/g, '<strong class="text-purple-300">$1</strong>')
                        .replace(/\n/g, '<br>')
                        .replace(/^(\d+\.)/gm, '<span class="text-cyan-400 font-bold">$1</span>');
                } else {
                    result.innerHTML = '<p class="text-red-400">Analiz sonucu alÄ±namadÄ±.</p>';
                }
            } catch (err) {
                result.innerHTML = `<p class="text-red-400">Hata: ${err.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="text-lg">ğŸ¤–</span> Yapay ZekÃ¢ Analizi';
            }
        };
        document.getElementById('close-hud').onclick = () => { document.getElementById('hud-panel').classList.add('hidden'); stopAudio(); };
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            if (warpCanvas) {
                const dpr = window.devicePixelRatio || 1;
                warpCanvas.width = window.innerWidth * dpr;
                warpCanvas.height = window.innerHeight * dpr;
                warpCanvas.style.width = window.innerWidth + 'px';
                warpCanvas.style.height = window.innerHeight + 'px';
                warpCtx.scale(dpr, dpr);
                warpCenterX = window.innerWidth / 2;
                warpCenterY = window.innerHeight / 2;
            }
        };

        // --- Ayarlar Modal FonksiyonlarÄ± ---
        window.openSettings = async () => {
            document.getElementById('settings-overlay').style.display = 'flex';
            renderKeyList();
            const infoDiv = document.getElementById('auth-user-info');
            const statusDiv = document.getElementById('server-status');
            const pwSection = document.getElementById('change-pw-section');
            if (isDesktopMode && authUser) {
                const roleLabels = { admin: 'ğŸ‘‘ Admin', editor: 'âœï¸ Editor', viewer: 'ğŸ‘ Viewer' };
                infoDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(0,242,255,0.05);border:1px solid rgba(0,242,255,0.15);border-radius:12px;margin-bottom:8px;">
                        <span style="font-size:24px;">ğŸ‘¤</span>
                        <div style="flex:1;"><div class="text-sm font-bold text-white">${authUser}</div><div class="text-[10px] text-cyan-500">${roleLabels[authRole] || authRole}</div></div>
                        <button onclick="doLogout()" class="bg-red-950/50 hover:bg-red-900/50 border border-red-400/20 px-4 py-2 rounded-xl font-black text-[10px] text-red-400 uppercase tracking-widest transition-all">Ã‡Ä±kÄ±ÅŸ</button>
                    </div>`;
                pwSection.style.display = '';
            } else {
                infoDiv.innerHTML = '<p class="text-[11px] text-slate-600">Bireysel mod â€” giriÅŸ gerekmez.</p>';
                pwSection.style.display = 'none';
            }
            if (isDesktopMode) {
                try {
                    const r = await fetch('/api/info');
                    const info = await r.json();
                    statusDiv.innerHTML = `<span class="text-green-400">â— Sunucu aktif</span> Â· AÄŸ: <code class="bg-black/40 px-2 py-0.5 rounded text-cyan-300">${info.url}</code>`;
                } catch { statusDiv.innerHTML = '<span class="text-green-400">â— Sunucu aktif</span>'; }
            } else {
                statusDiv.innerHTML = '<span class="text-slate-500">â—‹ Ã‡evrimdÄ±ÅŸÄ± mod (IndexedDB)</span>';
            }
        };
        window.saveUsername = () => {};
        window.closeSettings = () => {
            document.getElementById('settings-overlay').style.display = 'none';
            document.getElementById('api-key-guide').classList.add('hidden');
        };

        // --- Kimlik DoÄŸrulama FonksiyonlarÄ± ---
        const applyRoleUI = () => {
            const adminBtn = document.getElementById('admin-btn');
            if (adminBtn) adminBtn.style.display = authRole === 'admin' ? '' : 'none';
            const isViewer = authRole === 'viewer';
            const fileLabel = document.getElementById('file-input-label');
            const editorBtn = document.getElementById('editor-btn-header');
            if (isDesktopMode && fileLabel) fileLabel.style.display = isViewer ? 'none' : '';
            if (isDesktopMode && editorBtn) editorBtn.style.display = isViewer ? 'none' : '';
        };
        window.doLogin = async () => {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const err = document.getElementById('login-error');
            err.style.display = 'none';
            if (!username || !password) { err.textContent = 'KullanÄ±cÄ± adÄ± ve ÅŸifre gerekli'; err.style.display = 'block'; return; }
            try {
                const r = await fetch('/api/auth/login', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await r.json();
                if (!r.ok) { err.textContent = data.error; err.style.display = 'block'; return; }
                authToken = data.token;
                authUser = data.username;
                authRole = data.role;
                currentUser = data.username;
                localStorage.setItem('sgx_auth_token', authToken);
                localStorage.setItem('sgx_username', currentUser);
                document.getElementById('login-overlay').style.display = 'none';
                applyRoleUI();
                init();
                connectWS();
            } catch (e) {
                err.textContent = 'Sunucuya baÄŸlanÄ±lamadÄ±';
                err.style.display = 'block';
            }
        };
        window.doLogout = async () => {
            try { await authFetch('/api/auth/logout', { method: 'POST' }); } catch {}
            authToken = ''; authUser = ''; authRole = '';
            localStorage.removeItem('sgx_auth_token');
            location.reload();
        };
        window.openAdmin = async () => {
            document.getElementById('admin-overlay').style.display = 'flex';
            await renderUserList();
        };
        window.closeAdmin = () => { document.getElementById('admin-overlay').style.display = 'none'; };
        const renderUserList = async () => {
            const list = document.getElementById('admin-user-list');
            try {
                const r = await authFetch('/api/auth/users');
                if (!r.ok) { list.innerHTML = '<p class="text-xs text-red-400">Yetkisiz</p>'; return; }
                const users = await r.json();
                const roleLabels = { admin: 'ğŸ‘‘ Admin', editor: 'âœï¸ Editor', viewer: 'ğŸ‘ Viewer' };
                const roleColors = { admin: '#f59e0b', editor: '#06b6d4', viewer: '#64748b' };
                list.innerHTML = users.map(u => `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;">
                        <span style="font-size:20px;">ğŸ‘¤</span>
                        <div style="flex:1;"><div class="text-sm font-bold text-white">${u.username}</div><div class="text-[10px]" style="color:${roleColors[u.role]}">${roleLabels[u.role]}</div></div>
                        ${u.username !== authUser ? `
                        <select onchange="changeUserRole('${u.username}',this.value)" style="background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:4px 8px;color:white;font-size:10px;outline:none;">
                            <option value="viewer" ${u.role==='viewer'?'selected':''}>Viewer</option>
                            <option value="editor" ${u.role==='editor'?'selected':''}>Editor</option>
                            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                        </select>
                        <button onclick="deleteUser('${u.username}')" style="width:32px;height:32px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#ef4444;cursor:pointer;font-size:12px;">ğŸ—‘</button>
                        ` : '<span class="text-[10px] text-slate-600">(Siz)</span>'}
                    </div>
                `).join('');
            } catch { list.innerHTML = '<p class="text-xs text-red-400">Hata oluÅŸtu</p>'; }
        };
        window.createUser = async () => {
            const username = document.getElementById('new-user-name').value.trim();
            const password = document.getElementById('new-user-pass').value.trim();
            const role = document.getElementById('new-user-role').value;
            if (!username || !password) return;
            const r = await authFetch('/api/auth/users', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role })
            });
            if (r.ok) {
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-user-pass').value = '';
                await renderUserList();
            } else {
                const data = await r.json();
                alert(data.error || 'Hata');
            }
        };
        window.deleteUser = async (username) => {
            if (!confirm(username + ' silinsin mi?')) return;
            await authFetch('/api/auth/user/' + encodeURIComponent(username), { method: 'DELETE' });
            await renderUserList();
        };
        window.changeUserRole = async (username, role) => {
            await authFetch('/api/auth/user/' + encodeURIComponent(username), {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role })
            });
            await renderUserList();
        };
        window.changePassword = async () => {
            const oldPw = document.getElementById('old-pw-input').value;
            const newPw = document.getElementById('new-pw-input').value;
            const msg = document.getElementById('pw-change-msg');
            if (!oldPw || !newPw) { msg.innerHTML = '<span class="text-red-400">TÃ¼m alanlarÄ± doldurun</span>'; return; }
            const r = await authFetch('/api/auth/change-password', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldPassword: oldPw, newPassword: newPw })
            });
            const data = await r.json();
            if (r.ok) {
                msg.innerHTML = '<span class="text-green-400">âœ“ Åifre gÃ¼ncellendi</span>';
                document.getElementById('old-pw-input').value = '';
                document.getElementById('new-pw-input').value = '';
            } else {
                msg.innerHTML = `<span class="text-red-400">${data.error}</span>`;
            }
            setTimeout(() => { msg.innerHTML = ''; }, 3000);
        };
        window.showApiKeyGuide = () => {
            document.getElementById('settings-overlay').style.display = 'flex';
            document.getElementById('api-key-guide').classList.remove('hidden');
            renderKeyList();
        };
        const renderKeyList = () => {
            const list = document.getElementById('api-key-list');
            const keys = KeyManager.getKeys();
            if (keys.length === 0) {
                list.innerHTML = '<p class="text-[11px] text-slate-700 italic text-center py-4">HenÃ¼z API anahtarÄ± eklenmedi.</p>';
                return;
            }
            list.innerHTML = keys.map(k => {
                const masked = k.key.substring(0, 8) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + k.key.slice(-4);
                const statusCls = k.status === 'ok' ? 'ok' : k.status === 'fail' ? 'fail' : 'pending';
                const statusText = k.status === 'ok' ? 'âœ“ Aktif' : k.status === 'fail' ? 'âœ— Hata' : '? Bekliyor';
                const errorHint = k.status === 'fail' && k.error ? `<div style="font-size:9px;color:#f87171;margin-top:2px;word-break:break-all">${k.error}</div>` : '';
                return `
                    <div class="key-item ${k.status === 'ok' ? 'active' : ''}">
                        <span class="key-text">${masked}</span>
                        <span class="key-status ${statusCls}">${statusText}</span>
                        <button class="key-btn" onclick="removeApiKey('${k.key}')" title="Sil">ğŸ—‘</button>
                        ${errorHint}
                    </div>`;
            }).join('');
        };
        window.addApiKey = () => {
            const input = document.getElementById('new-key-input');
            const key = input.value.trim();
            if (!key) return;
            if (!key.startsWith('AIza')) {
                input.style.borderColor = '#ef4444';
                setTimeout(() => input.style.borderColor = '', 2000);
                return;
            }
            KeyManager.addKey(key);
            input.value = '';
            renderKeyList();
        };
        window.removeApiKey = (key) => {
            KeyManager.removeKey(key);
            if (apiKey === key) apiKey = null;
            renderKeyList();
        };
        window.testAllKeys = async () => {
            const keys = KeyManager.getKeys();
            for (const k of keys) {
                KeyManager.updateStatus(k.key, 'pending');
                renderKeyList();
                const result = await KeyManager.testKey(k.key);
                KeyManager.updateStatus(k.key, result.ok ? 'ok' : 'fail', result.error);
                if (result.ok && !apiKey) apiKey = k.key;
                renderKeyList();
            }
        };

        // --- Veri Seti YÃ¶neticisi ---
        window.toggleDipnot = () => {
            const div = document.getElementById('hud-dipnot');
            div.classList.toggle('hidden');
        };
        window.showDipnotPopup = (btn, nodeId) => {
            const item = btn.closest('.ayah-list-item');
            const existing = item.querySelector('.dipnot-inline');
            if (existing) { existing.remove(); return; }
            // DiÄŸer aÃ§Ä±k dipnotlarÄ± kapat
            document.querySelectorAll('.dipnot-inline').forEach(el => el.remove());
            const node = nodes.find(n => n.id === nodeId);
            const text = node?.dipnot || 'Bu ayet iÃ§in dipnot bulunmuyor.';
            const div = document.createElement('div');
            div.className = 'dipnot-inline';
            div.style.cssText = 'margin-top:8px;padding:10px 14px;background:rgba(120,53,15,0.3);border:1px solid rgba(245,158,11,0.2);border-radius:10px;font-size:12px;color:rgba(253,230,138,0.8);font-style:italic;line-height:1.6;';
            div.textContent = text;
            item.appendChild(div);
        };
        window.openDatasets = async () => {
            document.getElementById('dataset-overlay').style.display = 'flex';
            await renderDatasetList();
        };
        window.closeDatasets = () => { document.getElementById('dataset-overlay').style.display = 'none'; };
        const renderDatasetList = async () => {
            const list = document.getElementById('dataset-list');
            const datasets = await DatasetStore.getAll();
            const isViewer = authRole === 'viewer';
            let html = `<div class="ds-item ${activeDatasetName === 'quran_data.json' ? 'active' : ''}" onclick="switchDataset('__original__')">
                <span style="font-size:20px">ğŸ“„</span>
                <div class="flex-1">
                    <div class="text-sm font-bold text-white">quran_data.json</div>
                    <div class="text-[10px] text-slate-500">Orijinal veri seti</div>
                </div>
                ${activeDatasetName === 'quran_data.json' ? '<span class="text-[10px] text-cyan-400 font-bold uppercase tracking-widest">â— Aktif</span>' : ''}
                <button onclick="event.stopPropagation();downloadJSON(originalData,'quran_data.json')" class="key-btn" title="Ä°ndir" style="color:#38bdf8;border-color:rgba(56,189,248,0.3);">â¬‡</button>
            </div>`;
            datasets.forEach(d => {
                const esc = d.name.replace(/'/g, "\\'");
                const nc = d.nodeCount || d.data?.nodes?.length || 0;
                const who = d.modifiedBy ? ` Â· âœï¸ ${d.modifiedBy}` : '';
                const sizeStr = d.sizeKB ? ` Â· ${d.sizeKB >= 1024 ? (d.sizeKB / 1024).toFixed(1) + ' MB' : d.sizeKB + ' KB'}` : '';
                html += `<div class="ds-item ${activeDatasetName === d.name ? 'active' : ''}" onclick="switchDataset('${esc}')">
                    <span style="font-size:20px">ğŸ“</span>
                    <div class="flex-1">
                        <div class="text-sm font-bold text-white">${d.name}</div>
                        <div class="text-[10px] text-slate-500">${d.date || ''} Â· ${nc} ayet${sizeStr}${who}</div>
                    </div>
                    <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;">
                        ${activeDatasetName === d.name ? '<span class="text-[10px] text-cyan-400 font-bold uppercase tracking-widest">â— Aktif</span>' : ''}
                        <button onclick="event.stopPropagation();downloadDataset('${esc}')" class="key-btn" title="Ä°ndir" style="color:#38bdf8;border-color:rgba(56,189,248,0.3);font-size:11px;padding:4px 7px;">â¬‡</button>
                        ${!isViewer ? `<button onclick="event.stopPropagation();renameDataset('${esc}')" class="key-btn" title="Yeniden AdlandÄ±r" style="color:#a78bfa;border-color:rgba(167,139,250,0.3);font-size:11px;padding:4px 7px;">âœï¸</button>` : ''}
                        ${!isViewer ? `<button onclick="event.stopPropagation();duplicateDataset('${esc}')" class="key-btn" title="Ã‡oÄŸalt" style="color:#34d399;border-color:rgba(52,211,153,0.3);font-size:11px;padding:4px 7px;">ğŸ“‹</button>` : ''}
                        ${!isViewer ? `<button onclick="event.stopPropagation();deleteDataset('${esc}')" class="key-btn" title="Sil" style="font-size:11px;padding:4px 7px;">ğŸ—‘</button>` : ''}
                    </div>
                </div>`;
            });
            if (datasets.length === 0) html += '<p class="text-xs text-slate-600 italic text-center py-4 mt-2">HenÃ¼z harici veri seti yÃ¼klenmedi.<br>Ãœst menÃ¼den "VERÄ° OKU" ile JSON yÃ¼kleyin.</p>';
            list.innerHTML = html;
        };
        window.switchDataset = async (name) => {
            if (name === '__original__') {
                resetToOriginal();
            } else {
                const ds = await DatasetStore.get(name);
                if (ds) { activeDatasetName = name; processData(ds.data); hasCustomData = true; }
            }
            await renderDatasetList();
        };
        window.deleteDataset = async (name) => {
            if (!confirm('"' + name + '" silinsin mi?')) return;
            await DatasetStore.remove(name);
            if (activeDatasetName === name) resetToOriginal();
            await renderDatasetList();
        };
        window.renameDataset = async (oldName) => {
            const newName = prompt('Yeni dosya adÄ±:', oldName.replace('.json', ''));
            if (!newName || newName.trim() === '' || newName.trim() + '.json' === oldName) return;
            const finalName = newName.trim().endsWith('.json') ? newName.trim() : newName.trim() + '.json';
            if (isDesktopMode) {
                const r = await authFetch('/api/dataset-rename', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldName, newName: finalName })
                });
                const data = await r.json();
                if (!r.ok) { alert(data.error || 'Hata'); return; }
                if (activeDatasetName === oldName) activeDatasetName = finalName;
            } else {
                const ds = await DatasetStore.get(oldName);
                if (ds) {
                    await DatasetStore.save(finalName, ds.data);
                    await DatasetStore.remove(oldName);
                    if (activeDatasetName === oldName) activeDatasetName = finalName;
                }
            }
            await renderDatasetList();
        };
        window.duplicateDataset = async (sourceName) => {
            const base = sourceName.replace('.json', '');
            const newName = prompt('Kopya dosya adÄ±:', base + '_kopya');
            if (!newName || newName.trim() === '') return;
            const finalName = newName.trim().endsWith('.json') ? newName.trim() : newName.trim() + '.json';
            if (isDesktopMode) {
                const r = await authFetch('/api/dataset-duplicate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sourceName, newName: finalName })
                });
                const data = await r.json();
                if (!r.ok) { alert(data.error || 'Hata'); return; }
            } else {
                const ds = await DatasetStore.get(sourceName);
                if (ds) await DatasetStore.save(finalName, ds.data);
            }
            await renderDatasetList();
        };

        // --- JSON EditÃ¶r ---
        window.openEditor = async () => {
            let data;
            if (activeDatasetName === 'quran_data.json') {
                data = originalData;
            } else {
                const ds = await DatasetStore.get(activeDatasetName);
                data = ds ? ds.data : originalData;
            }
            if (!data) return;
            const ta = document.getElementById('editor-textarea');
            ta.value = JSON.stringify(data, null, 2);
            document.getElementById('editor-title').textContent = 'ğŸ“ ' + activeDatasetName;
            document.getElementById('json-editor').style.display = 'flex';
            updateEditorLines();
            editorValidate();
            ta.oninput = () => { updateEditorLines(); editorValidate(); };
            ta.onscroll = () => { document.getElementById('editor-lines').scrollTop = ta.scrollTop; };
        };
        window.closeEditor = () => { document.getElementById('json-editor').style.display = 'none'; };
        const updateEditorLines = () => {
            const ta = document.getElementById('editor-textarea');
            const count = ta.value.split('\n').length;
            const div = document.getElementById('editor-lines');
            let h = '';
            for (let i = 1; i <= count; i++) h += '<div style="padding:0 8px;">' + i + '</div>';
            div.innerHTML = h;
            div.scrollTop = ta.scrollTop;
        };
        window.editorValidate = () => {
            const ta = document.getElementById('editor-textarea');
            const bar = document.getElementById('editor-status');
            const msg = document.getElementById('editor-msg');
            const info = document.getElementById('editor-info');
            try {
                const data = JSON.parse(ta.value);
                const nc = data.nodes ? data.nodes.length : 0;
                bar.className = 'editor-status valid';
                msg.textContent = 'âœ“ GeÃ§erli JSON';
                info.textContent = nc + ' ayet Â· ' + ta.value.length.toLocaleString('tr-TR') + ' karakter';
                return true;
            } catch(e) {
                bar.className = 'editor-status invalid';
                const m = e.message.match(/position (\d+)/);
                if (m) {
                    const line = ta.value.substring(0, parseInt(m[1])).split('\n').length;
                    msg.textContent = 'âœ— Hata satÄ±r ' + line + ': ' + e.message;
                } else {
                    msg.textContent = 'âœ— ' + e.message;
                }
                info.textContent = '';
                return false;
            }
        };
        window.editorFormat = () => {
            const ta = document.getElementById('editor-textarea');
            try {
                ta.value = JSON.stringify(JSON.parse(ta.value), null, 2);
                updateEditorLines();
                editorValidate();
            } catch(e) { editorValidate(); }
        };
        window.editorSave = async () => {
            if (!editorValidate()) return;
            const data = JSON.parse(document.getElementById('editor-textarea').value);
            let saveName = activeDatasetName;
            if (activeDatasetName === 'quran_data.json') {
                saveName = 'quran_data_dÃ¼zenlenmiÅŸ.json';
                activeDatasetName = saveName;
                document.getElementById('editor-title').textContent = 'ğŸ“ ' + saveName;
            }
            await DatasetStore.save(saveName, data);
            processData(data);
            hasCustomData = true;
            const btn = document.querySelector('.editor-btn.save');
            btn.textContent = 'âœ“ Kaydedildi';
            setTimeout(() => { btn.textContent = 'ğŸ’¾ Kaydet'; }, 1500);
        };
        window.editorAddDipnot = () => {
            const ta = document.getElementById('editor-textarea');
            try {
                const data = JSON.parse(ta.value);
                if (!data.nodes) return;
                let count = 0;
                data.nodes.forEach(n => { if (!n.hasOwnProperty('dipnot')) { n.dipnot = ''; count++; } });
                ta.value = JSON.stringify(data, null, 2);
                updateEditorLines();
                editorValidate();
                const btn = document.querySelector('[onclick="editorAddDipnot()"]');
                btn.textContent = 'âœ“ ' + count + ' ayete eklendi';
                setTimeout(() => { btn.textContent = 'ğŸ“Œ Dipnot Ekle'; }, 2000);
            } catch(e) { editorValidate(); }
        };

        // --- DÄ±ÅŸa Aktarma ---
        const downloadJSON = async (data, filename) => {
            const content = JSON.stringify(data, null, 2);
            if (isDesktopMode && window.pywebview && window.pywebview.api && window.pywebview.api.save_file) {
                try {
                    const ok = await window.pywebview.api.save_file(content, filename);
                    if (ok) return;
                } catch(e) {}
            }
            const blob = new Blob([content], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        };
        window.editorExport = async () => {
            const ta = document.getElementById('editor-textarea');
            try {
                const data = JSON.parse(ta.value);
                await downloadJSON(data, activeDatasetName);
            } catch(e) { editorValidate(); }
        };
        window.downloadDataset = async (name) => {
            const ds = await DatasetStore.get(name);
            if (ds) await downloadJSON(ds.data, name);
        };

        // --- ArapÃ§a Sanal Klavye ---
        window.toggleArabicKb = () => {
            const kb = document.getElementById('arabic-kb');
            kb.classList.toggle('show');
            document.getElementById('kb-toggle').style.borderColor = kb.classList.contains('show') ? '#00f2ff' : '';
        };
        window.kbInsert = (ch) => {
            const ta = document.getElementById('editor-textarea');
            const s = ta.selectionStart, e = ta.selectionEnd;
            ta.value = ta.value.substring(0, s) + ch + ta.value.substring(e);
            ta.selectionStart = ta.selectionEnd = s + ch.length;
            ta.focus();
            updateEditorLines();
            editorValidate();
        };
        window.kbBackspace = () => {
            const ta = document.getElementById('editor-textarea');
            const s = ta.selectionStart, e = ta.selectionEnd;
            if (s !== e) {
                ta.value = ta.value.substring(0, s) + ta.value.substring(e);
                ta.selectionStart = ta.selectionEnd = s;
            } else if (s > 0) {
                ta.value = ta.value.substring(0, s - 1) + ta.value.substring(s);
                ta.selectionStart = ta.selectionEnd = s - 1;
            }
            ta.focus();
            updateEditorLines();
            editorValidate();
        };

        // --- WebSocket GerÃ§ek ZamanlÄ± Senkronizasyon ---
        let _ws = null, _wsReconnectTimer = null, _onlineUsers = [];
        const connectWS = () => {
            if (!isDesktopMode || !authToken) return;
            const wsPort = DatasetStore._wsPort || (parseInt(location.port) + 1);
            const wsUrl = `ws://${location.hostname}:${wsPort}/ws?token=${authToken}`;
            try {
                _ws = new WebSocket(wsUrl);
                _ws.onopen = () => {
                    updateOnlineIndicator();
                };
                _ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        handleWSMessage(msg);
                    } catch {}
                };
                _ws.onclose = () => {
                    _ws = null;
                    if (isDesktopMode && authToken) {
                        _wsReconnectTimer = setTimeout(connectWS, 3000);
                    }
                };
                _ws.onerror = () => {};
            } catch {}
        };
        const handleWSMessage = (msg) => {
            const isDatasetPanel = document.getElementById('dataset-overlay')?.style.display === 'flex';
            switch (msg.type) {
                case 'dataset_saved':
                    showToast(`ğŸ’¾ ${msg.username} "${msg.name}" kaydetti`, 'info');
                    if (isDatasetPanel) renderDatasetList();
                    break;
                case 'dataset_deleted':
                    showToast(`ğŸ—‘ ${msg.username} "${msg.name}" sildi`, 'warn');
                    if (isDatasetPanel) renderDatasetList();
                    if (activeDatasetName === msg.name) { resetToOriginal(); showToast('Aktif veri seti silindi, orijinale dÃ¶nÃ¼ldÃ¼', 'warn'); }
                    break;
                case 'dataset_renamed':
                    showToast(`âœï¸ ${msg.username} "${msg.oldName}" â†’ "${msg.newName}"`, 'info');
                    if (isDatasetPanel) renderDatasetList();
                    if (activeDatasetName === msg.oldName) activeDatasetName = msg.newName;
                    break;
                case 'dataset_duplicated':
                    showToast(`ğŸ“‹ ${msg.username} "${msg.sourceName}" Ã§oÄŸalttÄ±`, 'info');
                    if (isDatasetPanel) renderDatasetList();
                    break;
                case 'user_joined':
                    showToast(`ğŸŸ¢ ${msg.username} baÄŸlandÄ±`, 'success');
                    _onlineUsers = msg.online || [];
                    updateOnlineIndicator();
                    break;
                case 'user_left':
                    showToast(`ğŸ”´ ${msg.username} ayrÄ±ldÄ±`, 'muted');
                    _onlineUsers = msg.online || [];
                    updateOnlineIndicator();
                    break;
            }
        };
        const showToast = (text, type = 'info') => {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const colors = { info: '#06b6d4', warn: '#f59e0b', success: '#34d399', muted: '#64748b' };
            const toast = document.createElement('div');
            toast.style.cssText = `background:rgba(0,0,0,0.85);backdrop-filter:blur(16px);border:1px solid ${colors[type] || colors.info}40;border-left:3px solid ${colors[type] || colors.info};border-radius:12px;padding:10px 18px;color:#e2e8f0;font-size:11px;font-weight:600;pointer-events:auto;transform:translateX(120%);transition:transform 0.3s ease;max-width:340px;`;
            toast.textContent = text;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; });
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };
        const updateOnlineIndicator = () => {
            const el = document.getElementById('online-indicator');
            const countEl = document.getElementById('online-count');
            if (!el) return;
            if (isDesktopMode) {
                el.style.display = '';
                const count = _onlineUsers.length + (authUser && !_onlineUsers.includes(authUser) ? 1 : 0);
                countEl.textContent = count;
            } else {
                el.style.display = 'none';
            }
        };
        window.showOnlineList = async () => {
            try {
                const r = await authFetch('/api/online-users');
                if (r.ok) {
                    const data = await r.json();
                    _onlineUsers = data.users || [];
                    updateOnlineIndicator();
                    const names = [...new Set([..._onlineUsers, authUser].filter(Boolean))];
                    alert('Ã‡evrimiÃ§i: ' + names.join(', '));
                }
            } catch {}
        };

        // ======== WYSIWYG Notes System ========
        let _notes = [];
        let _activeNoteId = null;
        let _noteSaveTimer = null;

        const _notesKey = () => 'sgx_notes_' + (authUser || 'guest');

        const loadNotes = async () => {
            if (isDesktopMode && authToken) {
                try {
                    const r = await authFetch('/api/notes');
                    if (r.ok) { _notes = await r.json(); return; }
                } catch {}
            }
            try {
                const raw = localStorage.getItem(_notesKey());
                _notes = raw ? JSON.parse(raw) : [];
            } catch { _notes = []; }
        };

        const saveNotesToStorage = async () => {
            if (isDesktopMode && authToken) {
                try {
                    await authFetch('/api/notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(_notes)
                    });
                } catch {}
            }
            localStorage.setItem(_notesKey(), JSON.stringify(_notes));
        };

        const renderNotesList = () => {
            const sb = document.getElementById('notes-sidebar');
            if (!sb) return;
            sb.innerHTML = _notes.map(n => `
                <div class="note-item ${n.id === _activeNoteId ? 'active' : ''}" onclick="selectNote('${n.id}')">
                    <div class="note-title-text">${n.title || 'BaÅŸlÄ±ksÄ±z Not'}</div>
                    <div class="note-date">${new Date(n.updated).toLocaleDateString('tr-TR')}</div>
                </div>
            `).join('') || '<div style="padding:16px;font-size:10px;color:#475569;text-align:center;">HenÃ¼z not yok.<br>âœš ile yeni ekleyin.</div>';
        };

        const selectNote = (id) => {
            _activeNoteId = id;
            const note = _notes.find(n => n.id === id);
            if (note) {
                document.getElementById('note-title').value = note.title || '';
                document.getElementById('note-content').innerHTML = note.content || '';
            }
            renderNotesList();
        };

        const addNewNote = () => {
            const id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            const note = { id, title: '', content: '', created: new Date().toISOString(), updated: new Date().toISOString() };
            _notes.unshift(note);
            saveNotesToStorage();
            selectNote(id);
        };

        const deleteCurrentNote = async () => {
            if (!_activeNoteId) return;
            if (!confirm('Bu notu silmek istediÄŸinize emin misiniz?')) return;
            const delId = _activeNoteId;
            _notes = _notes.filter(n => n.id !== delId);
            if (isDesktopMode && authToken) {
                try { await authFetch('/api/note/' + encodeURIComponent(delId), { method: 'DELETE' }); } catch {}
            }
            await saveNotesToStorage();
            _activeNoteId = _notes.length > 0 ? _notes[0].id : null;
            if (_activeNoteId) selectNote(_activeNoteId);
            else {
                document.getElementById('note-title').value = '';
                document.getElementById('note-content').innerHTML = '';
            }
            renderNotesList();
        };

        const autoSaveNote = () => {
            if (!_activeNoteId) return;
            clearTimeout(_noteSaveTimer);
            _noteSaveTimer = setTimeout(() => {
                const note = _notes.find(n => n.id === _activeNoteId);
                if (!note) return;
                note.title = document.getElementById('note-title').value;
                note.content = document.getElementById('note-content').innerHTML;
                note.updated = new Date().toISOString();
                saveNotesToStorage();
                renderNotesList();
            }, 500);
        };

        const openNotes = async () => {
            await loadNotes();
            if (_notes.length === 0) addNewNote();
            else if (!_activeNoteId) selectNote(_notes[0].id);
            else selectNote(_activeNoteId);
            document.getElementById('notes-overlay').classList.add('show');
        };

        const closeNotes = () => {
            document.getElementById('notes-overlay').classList.remove('show');
        };

        const nCmd = (cmd, val) => {
            if (cmd === 'formatBlock') {
                document.execCommand('formatBlock', false, '<' + val + '>');
            } else if (cmd === 'insertHTML') {
                document.execCommand('insertHTML', false, val);
            } else {
                document.execCommand(cmd, false, null);
            }
            document.getElementById('note-content').focus();
            autoSaveNote();
        };

        const insertNoteLink = () => {
            const url = prompt('BaÄŸlantÄ± URL\'si:');
            if (url) document.execCommand('createLink', false, url);
            autoSaveNote();
        };

        // Notes overlay close on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'notes-overlay') closeNotes();
        });

        const _loadStart = Date.now();
        let _besmeleCtx = null;
        let _besmeleSource = null;
        let _besmeleGain = null;
        let _besmelePlaying = false;
        let _besmeleMinTime = 3000;

        (function() {
            const a = document.getElementById('besmele-audio');
            if (!a) return;
            const setDur = () => {
                if (a.duration && isFinite(a.duration)) {
                    _besmeleMinTime = Math.ceil(a.duration * 1000) + 800;
                }
            };
            a.addEventListener('loadedmetadata', setDur);
            if (a.readyState >= 1) setDur();
        })();

        const playBesmeleAudio = () => {
            if (_besmelePlaying) return;
            const audio = document.getElementById('besmele-audio');
            if (!audio) return;
            audio.volume = 0.7;

            const onPlay = () => { _besmelePlaying = true; };
            audio.addEventListener('playing', onPlay, { once: true });

            const showTapHint = () => {
                const hint = document.getElementById('loading-tap-hint');
                const spinner = document.getElementById('loading-spinner');
                const loadText = document.getElementById('loading-text');
                if (hint) hint.style.display = 'block';
                if (spinner) spinner.style.display = 'none';
                if (loadText) loadText.style.display = 'none';
            };

            const hideTapHint = () => {
                const hint = document.getElementById('loading-tap-hint');
                const spinner = document.getElementById('loading-spinner');
                const loadText = document.getElementById('loading-text');
                if (hint) hint.style.display = 'none';
                if (spinner) spinner.style.display = 'block';
                if (loadText) loadText.style.display = 'block';
            };

            audio.play().then(() => {
                _besmelePlaying = true;
            }).catch(() => {
                // Autoplay engellendi â€” kullanÄ±cÄ± etkileÅŸimi bekle
                showTapHint();

                const unlock = () => {
                    if (_besmelePlaying) return;
                    hideTapHint();
                    audio.currentTime = 0;
                    audio.play().then(() => { _besmelePlaying = true; }).catch(() => {});
                    document.removeEventListener('click', unlock);
                    document.removeEventListener('keydown', unlock);
                    document.removeEventListener('touchstart', unlock);
                };
                document.addEventListener('click', unlock, { once: true });
                document.addEventListener('keydown', unlock, { once: true });
                document.addEventListener('touchstart', unlock, { once: true });
            });
        };

        const fadeBesmeleAudio = () => {
            _besmelePlaying = true;
            // Desktop: Python winsound ile Ã§alÄ±nan sesi durdur
            if (window.pywebview && window.pywebview.api) {
                try { window.pywebview.api.stop_besmele(); } catch(e) {}
            }
            // Web: HTML audio veya Web Audio API fade-out
            const audio = document.getElementById('besmele-audio');
            if (_besmeleGain && _besmeleCtx && _besmeleSource) {
                try {
                    const now = _besmeleCtx.currentTime;
                    _besmeleGain.gain.setValueAtTime(_besmeleGain.gain.value, now);
                    _besmeleGain.gain.linearRampToValueAtTime(0, now + 1.2);
                    setTimeout(() => {
                        try { _besmeleSource.stop(); } catch(e) {}
                    }, 1300);
                } catch(e) {}
                return;
            }
            if (!audio || audio.paused) return;
            let vol = audio.volume;
            const fade = setInterval(() => {
                vol -= 0.05;
                if (vol <= 0) { clearInterval(fade); audio.pause(); audio.currentTime = 0; }
                else { audio.volume = vol; }
            }, 80);
        };

        const hideLoadingScreen = () => {
            const ls = document.getElementById('loading-screen');
            if (!ls || ls.style.display === 'none') return;

            const doHide = () => {
                const elapsed = Date.now() - _loadStart;
                const remaining = Math.max(0, _besmeleMinTime - elapsed);
                setTimeout(() => {
                    fadeBesmeleAudio();
                    ls.style.opacity = '0';
                    setTimeout(() => { ls.style.display = 'none'; }, 1200);
                }, remaining);
            };

            if (_besmelePlaying) {
                doHide();
            } else {
                // Besmele henÃ¼z Ã§almadÄ± â€” kullanÄ±cÄ± dokunmasÄ±nÄ± bekle, sonra kapat
                const waitForPlay = () => {
                    const audio = document.getElementById('besmele-audio');
                    if (audio) {
                        audio.addEventListener('playing', () => {
                            _loadStart = Date.now();
                            const setDur = () => {
                                if (audio.duration && isFinite(audio.duration)) {
                                    _besmeleMinTime = Math.ceil(audio.duration * 1000) + 800;
                                }
                                doHide();
                            };
                            if (audio.duration && isFinite(audio.duration)) setDur();
                            else audio.addEventListener('loadedmetadata', setDur, { once: true });
                        }, { once: true });
                    }
                };
                waitForPlay();
            }
        };

        window.onload = async () => {
            playBesmeleAudio();
            isDesktopMode = await DatasetStore._checkServer();
            let authValid = false;

            if (isDesktopMode && authToken) {
                try {
                    const r = await fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + authToken } });
                    if (r.ok) {
                        const data = await r.json();
                        authUser = data.username;
                        authRole = data.role;
                        currentUser = data.username;
                        authValid = true;
                    }
                } catch {}
                if (!authValid) {
                    authToken = '';
                    localStorage.removeItem('sgx_auth_token');
                }
            }

            if (isDesktopMode && !authValid) {
                const elapsed = Date.now() - _loadStart;
                const wait = Math.max(0, _besmeleMinTime - elapsed);
                setTimeout(() => {
                    fadeBesmeleAudio();
                    const ls = document.getElementById('loading-screen');
                    ls.style.opacity = '0';
                    setTimeout(() => {
                        ls.style.display = 'none';
                        document.getElementById('login-overlay').style.display = 'flex';
                    }, 1200);
                }, wait);
            } else {
                if (isDesktopMode) {
                    applyRoleUI();
                    connectWS();
                }
                init();
            }
        };
    </script>
</body>
</html>